<div class="table-container" [class]="getTableClasses()">
  <!-- Loading overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-content">
      <svg class="loading-spinner" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Cargando...</span>
    </div>
  </div>

  <!-- Table -->
  <table class="table-element">
    <!-- Header -->
    <thead *ngIf="showHeader" [class]="getHeaderClasses()">
      <tr>
        <!-- Column headers -->
        <th
          *ngFor="let column of columns"
          [class]="getCellClasses(column)"
          (click)="onSort(column)"
          [class.sortable-header]="sortable && column.sortable"
        >
          <div class="header-content" [class.header-align-right]="column.align === 'right'" [class.header-align-center]="column.align === 'center'">
            <span>{{ column.label }}</span>
          </div>
        </th>

        <!-- Actions header -->
        <th *ngIf="actions || actionsTemplate" class="actions-header">
          <span>Acciones</span>
        </th>
      </tr>
    </thead>

    <!-- Body -->
    <tbody>
      <!-- Data rows -->
      <ng-container *ngIf="data.length > 0">
        <tr
          *ngFor="let item of data; let i = index"
          [class]="getRowClasses(i)"
          (click)="onRowClick(item)"
          [class.clickable-row]="rowClick.observers.length > 0"
        >
          <!-- Data cells -->
          <td
            *ngFor="let column of columns"
            [class]="getCellClasses(column)"
          >
            <!-- Status template for state column -->
            <ng-container *ngIf="column.key === 'state'">
              <span class="status-badge"
                    [class.status-active]="item.state === 'active'"
                    [class.status-inactive]="item.state === 'inactive'"
                    [class.status-suspended]="item.state === 'suspended'"
                    [class.status-draft]="item.state === 'draft'">
                {{ item.state === 'active' ? 'Active' : item.state === 'inactive' ? 'Inactive' : item.state === 'suspended' ? 'Suspended' : 'Draft' }}
              </span>
            </ng-container>
            
            <!-- Custom template if provided -->
            <ng-container
              *ngIf="column.template && column.key !== 'state'; else defaultContent"
              [ngTemplateOutlet]="column.template"
              [ngTemplateOutletContext]="{ $implicit: item, column: column }"
            ></ng-container>
            
            <!-- Default content -->
            <ng-template #defaultContent>
              <span class="cell-content" *ngIf="column.key !== 'state'">
                <ng-container *ngIf="getNestedValue(item, column.key) !== null && getNestedValue(item, column.key) !== undefined && getNestedValue(item, column.key) !== ''; else noDataTemplate">
                  {{ column.transform ? column.transform(getNestedValue(item, column.key)) : getNestedValue(item, column.key) }}
                </ng-container>
                <ng-template #noDataTemplate>
                  <span class="cell-content-empty">{{ column.defaultValue || 'Data not found' }}</span>
                </ng-template>
              </span>
            </ng-template>
          </td>

          <!-- Actions cell -->
          <td *ngIf="actions || actionsTemplate" class="actions-cell">
            <!-- Custom actions template -->
            <ng-container
              *ngIf="actionsTemplate; else defaultActions"
              [ngTemplateOutlet]="actionsTemplate"
              [ngTemplateOutletContext]="{ $implicit: item }"
            ></ng-container>
            
            <!-- Default actions -->
            <ng-template #defaultActions>
              <div class="table-actions">
                <ng-container *ngFor="let action of actions">
                  <button
                    *ngIf="isActionVisible(action, item)"
                    [class]="getActionClasses(action, item)"
                    [disabled]="isActionDisabled(action, item)"
                    (click)="executeAction(action, item); $event.stopPropagation()"
                    [attr.title]="action.label"
                  >
                    <!-- Icon if provided -->
                    <app-icon
                      *ngIf="action.icon"
                      [name]="action.icon"
                      [size]="12"
                    ></app-icon>
                    
                    <!-- Label (only show if no icon or on larger sizes) -->
                    <span *ngIf="!action.icon || size === 'lg'">{{ action.label }}</span>
                  </button>
                </ng-container>
              </div>
            </ng-template>
          </td>
        </tr>
      </ng-container>

      <!-- Empty state -->
      <tr *ngIf="!loading && data.length === 0">
        <td [attr.colspan]="columns.length + (actions || actionsTemplate ? 1 : 0)" class="empty-cell">
          <div class="empty-state">
            <svg class="empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span class="empty-message">{{ emptyMessage }}</span>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
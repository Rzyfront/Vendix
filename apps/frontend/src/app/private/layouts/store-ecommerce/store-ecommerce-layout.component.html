<div class="ecommerce-layout">
  <!-- Header -->
  <header class="ecommerce-header">
    <div class="header-container">
      <!-- Mobile Logo -->
      <a routerLink="/" class="mobile-logo">
        @if (store_logo) {
        <img [src]="store_logo" [alt]="store_name" class="mobile-logo-img" />
        } @else {
        <div class="mobile-logo-fallback">
          <app-icon name="shopping-bag" [size]="22"></app-icon>
        </div>
        }
      </a>

      <div class="header-left">
        <!-- Logo (Desktop) -->
        <a routerLink="/" class="logo desktop-logo">
          @if (store_logo) {
          <img [src]="store_logo" [alt]="store_name" class="logo-img" />
          } @else {
          <div class="logo-fallback">
            <app-icon name="shopping-bag" [size]="24" class="logo-icon"></app-icon>
            <span class="logo-text">{{ store_name }}</span>
          </div>
          }
        </a>

        <!-- Navigation -->
        <nav class="main-nav desktop-only">
          <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">Inicio</a>
          <a routerLink="/products" routerLinkActive="active">Productos</a>
          <a routerLink="/new" routerLinkActive="active">Novedades</a>
          <a routerLink="/sale" routerLinkActive="active">Ofertas</a>
        </nav>
      </div>

      <!-- Search Autocomplete -->
      <app-search-autocomplete class="header-search" />

      <!-- Actions -->
      <div class="header-actions">
        <!-- Icons visible only if authenticated (Desktop Only) -->
        <div class="desktop-actions">
          @if (is_authenticated$ | async) {
          <!-- Wishlist with badge and animation -->
          <div class="wishlist-container">
            @if (wishlist_badge$ | async; as badge) {
              <button class="action-btn wishlist-btn"
                      [class.shake-animation]="is_wishlist_animating"
                      [class.has-items]="badge.show"
                      (click)="goToWishlist()" title="Favoritos">
                <app-icon name="heart" [size]="20"></app-icon>
                @if (badge.show) {
                  <span class="wishlist-badge">{{ badge.count }}</span>
                }
              </button>
            } @else {
              <button class="action-btn wishlist-btn"
                      [class.shake-animation]="is_wishlist_animating"
                      (click)="goToWishlist()" title="Favoritos">
                <app-icon name="heart" [size]="20"></app-icon>
              </button>
            }

            @if (show_wishlist_added_tooltip) {
              <div class="wishlist-tooltip">
                <div class="tooltip-arrow"></div>
                <div class="tooltip-content">
                  <app-icon name="heart" [size]="16" class="text-error"></app-icon>
                  <span>Producto agregado a favoritos</span>
                </div>
              </div>
            }
          </div>

          <!-- User Profile Icon -->
          <button class="action-btn" (click)="goToAccount()" title="Mi Perfil">
            <app-icon name="user-circle" [size]="20"></app-icon>
          </button>
          }
        </div>

        <!-- Cart Dropdown Container -->
        <div class="cart-container" (mouseenter)="onCartEnter()" (mouseleave)="onCartLeave()">
          <button class="action-btn cart-btn" [class.shake-animation]="is_animating" (click)="goToCart()"
            title="Carrito">
            <app-icon name="shopping-cart" [size]="20"></app-icon>
            @if (cart_badge$ | async; as badge) {
            @if (badge.show) {
            <span class="cart-badge">{{ badge.count }}</span>
            }
            }
          </button>

          <!-- Added to Cart Tooltip -->
          @if (show_added_tooltip && !show_cart_dropdown) {
          <div class="cart-tooltip">
            <div class="tooltip-arrow"></div>
            <div class="tooltip-content">
              <app-icon name="check-circle" [size]="16" class="text-success"></app-icon>
              <span>Se agregó nuevo producto al carrito</span>
            </div>
          </div>
          }

          <!-- Dropdown -->
          @if (show_cart_dropdown) {
          <div class="cart-dropdown">
            <div class="cart-header">
              <div class="header-title" style="display: flex; align-items: center; gap: 0.5rem;">
                <app-icon name="shopping-cart" [size]="20" class="text-primary"></app-icon>
                <h3>Mi Carrito</h3>
              </div>
              @if (cart$ | async; as cart) {
              <span>{{ cart.item_count }} items</span>
              }
            </div>

            <div class="cart-items">
              @if (cart$ | async; as cart) {
              @if (cart.items.length > 0) {
              @for (item of cart.items; track item.id) {
              <div class="cart-item">
                <div class="item-image">
                  @if (item.product.image_url) {
                  <img [src]="item.product.image_url" [alt]="item.product.name">
                  } @else {
                  <div class="placeholder-img">
                    <app-icon name="image" [size]="16"></app-icon>
                  </div>
                  }
                </div>
                <div class="item-details">
                  <p class="item-name">{{ item.product.name }}</p>
                  <p class="item-price">{{ item.unit_price | currency }}</p>

                  <div class="item-controls">
                    <app-quantity-control [value]="item.quantity" [min]="1" [size]="'sm'"
                      (valueChange)="updateCartQuantity(item, $event)"></app-quantity-control>
                    <app-button variant="ghost" size="xsm" class="remove-btn" (clicked)="removeCartItem(item)">
                      <app-icon name="trash-2" [size]="14"></app-icon>
                    </app-button>
                  </div>
                </div>
              </div>
              }
              } @else {
              <div class="empty-cart">
                <app-icon name="shopping-cart" [size]="48" class="text-gray-300"></app-icon>
                <p>Tu carrito está vacío</p>
              </div>
              }
              }
            </div>

            @if (cart$ | async; as cart) {
            @if (cart.items.length > 0) {
            <div class="cart-footer">
              <div class="cart-total">
                <span>Total:</span>
                <span class="total-amount">{{ cart.subtotal | currency }}</span>
              </div>
              <div class="cart-actions">
                <app-button variant="ghost" size="sm" (clicked)="clearCart()">Vaciar</app-button>
                <app-button variant="primary" size="sm" [fullWidth]="true" (clicked)="goToCart()">Ver Carrito</app-button>
              </div>
            </div>
            }
            }
          </div>
          }
        </div>

        <!-- User Menu (Guest or Authenticated Dropdown) - DESKTOP ONLY -->
        <div class="user-menu-container desktop-only">
          <button class="user-btn" (click)="toggleUserMenu()">
            @if (is_authenticated$ | async) {
            <span class="user-name">{{ user_name$ | async }}</span>
            <app-icon name="chevron-down" [size]="12" class="chevron-icon"></app-icon>
            } @else {
            <app-icon name="user" [size]="20"></app-icon>
            }
          </button>
          @if (show_user_menu) {
          <div class="user-dropdown">
            @if (is_authenticated$ | async) {
            <a (click)="goToAccount()">
              <app-icon name="user" [size]="16"></app-icon> Ver Perfil
            </a>
            <a (click)="goToWishlist()">
              <app-icon name="heart" [size]="16"></app-icon> Favoritos
            </a>
            <a (click)="goToOrders()">
              <app-icon name="list" [size]="16"></app-icon> Ordenes
            </a>
            <hr />
            <a (click)="logout()" class="logout-link">
              <app-icon name="logout" [size]="16"></app-icon> Cerrar Sesión
            </a>
            } @else {
            <a (click)="login()">
              <app-icon name="log-in" [size]="16"></app-icon> Iniciar Sesión
            </a>
            <a (click)="register()">
              <app-icon name="user-plus" [size]="16"></app-icon> Registrarse
            </a>
            }
          </div>
          }
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-btn" (click)="toggleMobileMenu()">
          <app-icon name="menu" [size]="24"></app-icon>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="ecommerce-main">
    <router-outlet></router-outlet>
  </main>

  <!-- Footer (Dynamic) -->
  <footer class="ecommerce-footer">
    <div class="footer-container">
      <!-- Sección 1: Información de la Tienda -->
      <div class="footer-section">
        <h4>{{ store_name }}</h4>
        <p>{{ getTagline() }}</p>
        @if (hasAboutUs()) {
        <a class="cursor-pointer hover:text-[var(--color-primary)]" (click)="show_about_modal = true">Sobre Nosotros</a>
        }
        @if (footer_settings?.store_info?.support_email) {
        <a [href]="'mailto:' + footer_settings!.store_info!.support_email" class="hover:text-[var(--color-primary)]">
          {{ footer_settings!.store_info!.support_email }}
        </a>
        }
      </div>

      <!-- Sección 2: Enlaces -->
      <div class="footer-section">
        <h4>Enlaces</h4>
        @for (link of getFooterLinks(); track link.url) {
          @if (link.is_external) {
          <a [href]="link.url" target="_blank" rel="noopener noreferrer">{{ link.label }}</a>
          } @else {
          <a [routerLink]="link.url">{{ link.label }}</a>
          }
        }
      </div>

      <!-- Sección 3: Ayuda -->
      <div class="footer-section">
        <h4>Ayuda</h4>
        @if (hasFaq()) {
        <a class="cursor-pointer hover:text-[var(--color-primary)]" (click)="show_faq_modal = true">Preguntas Frecuentes</a>
        }
        @if (hasShippingInfo()) {
        <a class="cursor-pointer hover:text-[var(--color-primary)]" (click)="show_shipping_modal = true">Envíos</a>
        }
        @if (hasReturnsInfo()) {
        <a class="cursor-pointer hover:text-[var(--color-primary)]" (click)="show_returns_modal = true">Devoluciones</a>
        }
        @if (!hasFaq() && !hasShippingInfo() && !hasReturnsInfo()) {
        <p class="text-sm text-[var(--color-text-muted)]">Contáctanos para ayuda</p>
        }
      </div>

      <!-- Sección 4: Redes Sociales -->
      <div class="footer-section">
        <h4>Síguenos</h4>
        <div class="social-links">
          @if (hasValidSocialLink('facebook')) {
          <a [href]="footer_settings!.social!.facebook!.url" target="_blank" rel="noopener noreferrer">
            <app-icon name="facebook" [size]="20"></app-icon>
          </a>
          }
          @if (hasValidSocialLink('instagram')) {
          <a [href]="footer_settings!.social!.instagram!.url" target="_blank" rel="noopener noreferrer">
            <app-icon name="instagram" [size]="20"></app-icon>
          </a>
          }
          @if (hasValidSocialLink('tiktok')) {
          <a [href]="footer_settings!.social!.tiktok!.url" target="_blank" rel="noopener noreferrer">
            <!-- TikTok: SVG inline because Lucide doesn't have an official TikTok icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
            </svg>
          </a>
          }
          @if (!hasValidSocialLink('facebook') && !hasValidSocialLink('instagram') && !hasValidSocialLink('tiktok')) {
          <p class="text-sm text-[var(--color-text-muted)]">Próximamente</p>
          }
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; {{ store_name }} {{ current_year }}. Todos los derechos reservados.</p>
    </div>
  </footer>
</div>

<!-- Overlay for mobile menu -->
@if (show_mobile_menu) {
<div class="mobile-overlay" (click)="toggleMobileMenu()"></div>
}

<!-- Mobile Sidebar (Root Level) -->
<aside class="mobile-sidebar" [class.open]="show_mobile_menu">
  <!-- Mobile User Header -->
  <div class="mobile-nav-header">
    @if (is_authenticated$ | async) {
    <div class="user-info">
      <div class="avatar-circle">
        <app-icon name="user" [size]="20"></app-icon>
      </div>
      <div class="user-details">
        <span class="greeting">Hola,</span>
        <span class="name">{{ user_name$ | async }}</span>
      </div>
    </div>
    } @else {
    <div class="guest-info">
      <span class="welcome-text">Bienvenido</span>
      <p class="sub-text">Inicia sesión para ver tus beneficios</p>
    </div>
    }
    <button class="close-menu-btn" (click)="toggleMobileMenu()">
      <app-icon name="x" [size]="24"></app-icon>
    </button>
  </div>

  <!-- Scroll Content -->
  <div class="nav-scroll-content">
    <div class="nav-section">
      <h5 class="nav-subtitle">Menú Principal</h5>
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
        (click)="toggleMobileMenu()">Inicio</a>
      <a routerLink="/products" routerLinkActive="active" (click)="toggleMobileMenu()">Productos</a>
      <a routerLink="/new" routerLinkActive="active" (click)="toggleMobileMenu()">Novedades</a>
      <a routerLink="/sale" routerLinkActive="active" (click)="toggleMobileMenu()">Ofertas</a>
    </div>

    <hr class="nav-divider">

    <div class="nav-section user-section">
      <h5 class="nav-subtitle">Mi Cuenta</h5>
      @if (is_authenticated$ | async) {
      <a (click)="goToAccount(); toggleMobileMenu()">
        <app-icon name="user" [size]="18"></app-icon> Mi Perfil
      </a>
      @if (wishlist_badge$ | async; as badge) {
        <a (click)="goToWishlist(); toggleMobileMenu()"
           class="wishlist-mobile-link"
           [class.has-items]="badge.show">
          <app-icon name="heart" [size]="18"></app-icon> Favoritos
          @if (badge.show) {
            <span class="mobile-badge">{{ badge.count }}</span>
          }
        </a>
      } @else {
        <a (click)="goToWishlist(); toggleMobileMenu()" class="wishlist-mobile-link">
          <app-icon name="heart" [size]="18"></app-icon> Favoritos
        </a>
      }
      <a (click)="goToOrders(); toggleMobileMenu()">
        <app-icon name="list" [size]="18"></app-icon> Mis Ordenes
      </a>
      <a (click)="logout(); toggleMobileMenu()" class="logout-link">
        <app-icon name="logout" [size]="18"></app-icon> Cerrar Sesión
      </a>
      } @else {
      <a (click)="login(); toggleMobileMenu()">
        <app-icon name="log-in" [size]="18"></app-icon> Iniciar Sesión
      </a>
      <a (click)="register(); toggleMobileMenu()">
        <app-icon name="user-plus" [size]="18"></app-icon> Registrarse
      </a>
      }
    </div>
  </div>
</aside>

<app-auth-modal [isOpen]="is_auth_modal_open" [initialMode]="auth_modal_mode" [storeLogo]="store_logo"
  [storeName]="store_name" (closed)="is_auth_modal_open = false"></app-auth-modal>

<!-- Footer Modals -->
@if (show_about_modal) {
<app-info-modal
  [isOpen]="true"
  title="Sobre Nosotros"
  [content]="footer_settings?.store_info?.about_us || ''"
  (closed)="show_about_modal = false">
</app-info-modal>
}

@if (show_faq_modal) {
<app-faq-modal
  [isOpen]="true"
  [items]="footer_settings?.help?.faq || []"
  (closed)="show_faq_modal = false">
</app-faq-modal>
}

@if (show_shipping_modal) {
<app-info-modal
  [isOpen]="true"
  title="Información de Envíos"
  [content]="footer_settings?.help?.shipping_info || ''"
  (closed)="show_shipping_modal = false">
</app-info-modal>
}

@if (show_returns_modal) {
<app-info-modal
  [isOpen]="true"
  title="Política de Devoluciones"
  [content]="footer_settings?.help?.returns_info || ''"
  (closed)="show_returns_modal = false">
</app-info-modal>
}
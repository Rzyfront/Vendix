<app-modal
  [(isOpen)]="isOpen"
  [title]="
    'Order Details - ' +
    (orderDetails?.order_number || order?.order_number || '')
  "
  size="lg"
  
>
  <div class="space-y-2 md:space-y-4" *ngIf="!isLoading && orderDetails">
    <!-- Order Header -->
    <div class="bg-surface rounded-card border border-border p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-4">
        <div>
          <p class="text-sm text-text-secondary">Número de orden</p>
          <p class="font-semibold text-text-primary">
            {{ orderDetails.order_number }}
          </p>
        </div>
        <div>
          <p class="text-sm text-text-secondary">Fecha del pedido</p>
          <p class="font-semibold text-text-primary">
            {{ formatDate(orderDetails.order_date) }}
          </p>
        </div>
        <div>
          <p class="text-sm text-text-secondary">Importe total</p>
          <p class="font-semibold text-text-primary">
            {{ formatCurrency(orderDetails.total_amount) }}
          </p>
        </div>
      </div>
    </div>

    <!-- Customer & Store Information -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:p-4">
      <!-- Customer Info -->
      <div class="bg-surface rounded-card border border-border p-4">
        <h3 class="font-semibold text-text-primary mb-3 flex items-center">
          <app-icon name="user" [size]="16" class="mr-2"></app-icon>
          Customer Information
        </h3>
        <div class="space-y-2">
          <div>
            <p class="text-sm text-text-secondary">Nombre</p>
            <p class="font-medium text-text-primary">{{ getCustomerName() }}</p>
          </div>
          <div>
            <p class="text-sm text-text-secondary">Email</p>
            <p class="font-medium text-text-primary">
              {{ orderDetails.customer.email }}
            </p>
          </div>
          <div *ngIf="orderDetails.customer.phone">
            <p class="text-sm text-text-secondary">Teléfono</p>
            <p class="font-medium text-text-primary">
              {{ orderDetails.customer.phone }}
            </p>
          </div>
        </div>
      </div>

      <!-- Store Info -->
      <div class="bg-surface rounded-card border border-border p-4">
        <h3 class="font-semibold text-text-primary mb-3 flex items-center">
          <app-icon name="store" [size]="16" class="mr-2"></app-icon>
          Información de la tienda
        </h3>
        <div class="space-y-2">
          <div>
            <p class="text-sm text-text-secondary">Nombre de la tienda</p>
            <p class="font-medium text-text-primary">{{ getStoreName() }}</p>
          </div>
          <div>
            <p class="text-sm text-text-secondary">Tipo de orden</p>
            <p class="font-medium text-text-primary">
              {{ orderDetails.order_type }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Information -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:p-4">
      <!-- Order Status -->
      <div class="bg-surface rounded-card border border-border p-4">
        <h3 class="font-semibold text-text-primary mb-3 flex items-center">
          <app-icon name="info" [size]="16" class="mr-2"></app-icon>
          Estado del pedido
        </h3>
        <div class="space-y-3">
          <div>
            <p class="text-sm text-text-secondary">Estado actual</p>
            <span
              class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
              [class]="getStatusColor(orderDetails.status)"
            >
              {{ orderDetails.status }}
            </span>
          </div>
          <div>
            <p class="text-sm text-text-secondary">Estado del pago</p>
            <span
              class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
              [class]="getPaymentStatusColor(orderDetails.payment_status)"
            >
              {{ orderDetails.payment_status }}
            </span>
          </div>
          <div *ngIf="orderDetails.payment_method">
            <p class="text-sm text-text-secondary">Método de pago</p>
            <p class="font-medium text-text-primary">
              {{ orderDetails.payment_method }}
            </p>
          </div>
        </div>
      </div>

      <!-- Tracking Information -->
      <div class="bg-surface rounded-card border border-border p-4">
        <h3 class="font-semibold text-text-primary mb-3 flex items-center">
          <app-icon name="truck" [size]="16" class="mr-2"></app-icon>
          Información de seguimiento
        </h3>
        <div class="space-y-3">
          <div *ngIf="orderDetails.tracking_number">
            <p class="text-sm text-text-secondary">El número de rastreo</p>
            <p class="font-medium text-text-primary">
              {{ orderDetails.tracking_number }}
            </p>
          </div>
          <div *ngIf="orderDetails.estimated_delivery">
            <p class="text-sm text-text-secondary">Entrega estimada</p>
            <p class="font-medium text-text-primary">
              {{ formatDate(orderDetails.estimated_delivery) }}
            </p>
          </div>
          <div *ngIf="orderDetails.delivered_at">
            <p class="text-sm text-text-secondary">Entregado en</p>
            <p class="font-medium text-text-primary">
              {{ formatDate(orderDetails.delivered_at) }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="bg-surface rounded-card border border-border p-4">
      <h3 class="font-semibold text-text-primary mb-3 flex items-center">
        <app-icon name="package" [size]="16" class="mr-2"></app-icon>
        Artículos del pedido
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-border">
          <thead class="bg-surface">
            <tr>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-text-secondary uppercase tracking-wider"
              >
                Producto
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-text-secondary uppercase tracking-wider"
              >
                SKU
              </th>
              <th
                class="px-4 py-2 text-center text-xs font-medium text-text-secondary uppercase tracking-wider"
              >
                Cantidad
              </th>
              <th
                class="px-4 py-2 text-right text-xs font-medium text-text-secondary uppercase tracking-wider"
              >
                Precio unitario
              </th>
              <th
                class="px-4 py-2 text-right text-xs font-medium text-text-secondary uppercase tracking-wider"
              >
                Total
              </th>
            </tr>
          </thead>
          <tbody class="bg-surface divide-y divide-border">
            <tr *ngFor="let item of orderDetails.items">
              <td class="px-4 py-2 text-sm text-text-primary">
                {{ item.product_name }}
              </td>
              <td class="px-4 py-2 text-sm text-text-primary">
                {{ item.product_sku }}
              </td>
              <td class="px-4 py-2 text-sm text-text-primary text-center">
                {{ item.quantity }}
              </td>
              <td class="px-4 py-2 text-sm text-text-primary text-right">
                {{ formatCurrency(item.unit_price) }}
              </td>
              <td class="px-4 py-2 text-sm text-text-primary text-right">
                {{ formatCurrency(item.total_price) }}
              </td>
            </tr>
          </tbody>
          <tfoot class="bg-surface">
            <tr>
              <td
                colspan="4"
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                Subtotal:
              </td>
              <td
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                {{ formatCurrency(orderDetails.subtotal) }}
              </td>
            </tr>
            <tr *ngIf="orderDetails.tax_amount > 0">
              <td
                colspan="4"
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                Tax:
              </td>
              <td
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                {{ formatCurrency(orderDetails.tax_amount) }}
              </td>
            </tr>
            <tr *ngIf="orderDetails.shipping_amount > 0">
              <td
                colspan="4"
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                Envío:
              </td>
              <td
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                {{ formatCurrency(orderDetails.shipping_amount) }}
              </td>
            </tr>
            <tr *ngIf="orderDetails.discount_amount > 0">
              <td
                colspan="4"
                class="px-4 py-2 text-sm font-medium text-text-primary text-right"
              >
                Descuento:
              </td>
              <td class="px-4 py-2 text-sm font-medium text-red-600 text-right">
                -{{ formatCurrency(orderDetails.discount_amount) }}
              </td>
            </tr>
            <tr class="border-t-2 border-border">
              <td
                colspan="4"
                class="px-4 py-2 text-sm font-bold text-text-primary text-right"
              >
                Total:
              </td>
              <td
                class="px-4 py-2 text-sm font-bold text-text-primary text-right"
              >
                {{ formatCurrency(orderDetails.total_amount) }}
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Notes -->
    <div
      *ngIf="orderDetails.notes"
      class="bg-surface rounded-card border border-border p-4"
    >
      <h3 class="font-semibold text-text-primary mb-3 flex items-center">
        <app-icon name="file-text" [size]="16" class="mr-2"></app-icon>
        Notas del pedido
      </h3>
      <p class="text-sm text-text-primary">{{ orderDetails.notes }}</p>
    </div>

    <!-- Update Form -->
    <form [formGroup]="updateForm" class="space-y-2 md:space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4">
        <div>
          <label class="block text-sm font-medium text-text-primary mb-1"
            >Estado del pedido</label
          >
          <select
            formControlName="status"
            class="w-full px-3 py-2 border border-border rounded-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-surface text-text-primary text-sm"
          >
            <option value="">Seleccionar estado</option>
            <option value="pending">Pendiente</option>
            <option value="confirmed">Confirmado</option>
            <option value="processing">Procesando</option>
            <option value="shipped">Enviado</option>
            <option value="delivered">Entregado</option>
            <option value="cancelled">Cancelada</option>
            <option value="refunded">Reintegrada</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-text-primary mb-1"
            >Estado del pago</label
          >
          <select
            formControlName="payment_status"
            class="w-full px-3 py-2 border border-border rounded-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-surface text-text-primary text-sm"
          >
            <option value="">Seleccionar estado de pago</option>
            <option value="pending">Pendiente</option>
            <option value="paid">Pagado</option>
            <option value="failed">Fallido</option>
            <option value="refunded">Reintegrado</option>
            <option value="partially_refunded">Parcialmente Reintegrado</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4">
        <div>
          <label class="block text-sm font-medium text-text-primary mb-1"
            >El número de rastreo</label
          >
          <input
            type="text"
            formControlName="tracking_number"
            placeholder="Enter tracking number"
            class="w-full px-3 py-2 border border-border rounded-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-surface text-text-primary text-sm"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-text-primary mb-1"
            >Entrega estimada</label
          >
          <input
            type="datetime-local"
            formControlName="estimated_delivery"
            class="w-full px-3 py-2 border border-border rounded-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-surface text-text-primary text-sm"
          />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-text-primary mb-1"
          >Notas</label
        >
        <textarea
          formControlName="notes"
          rows="3"
          placeholder="Enter order notes"
          class="w-full px-3 py-2 border border-border rounded-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-surface text-text-primary text-sm"
        ></textarea>
      </div>
    </form>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex items-center justify-center py-8">
    <div
      class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"
    ></div>
    <p class="ml-2 text-text-secondary">Cargando detalles del pedido...</p>
  </div>

  <!-- Modal Actions -->
  <div class="flex justify-between items-center pt-4 border-t border-border">
    <div class="flex gap-2">
      <app-button
        variant="outline"
        size="sm"
        (clicked)="onPrintInvoice()"
        [disabled]="isLoading"
      >
        <app-icon name="printer" [size]="16" slot="icon"></app-icon>
        Imprimir factura
      </app-button>
      <app-button
        variant="outline"
        size="sm"
        (clicked)="onPrintPackingSlip()"
        [disabled]="isLoading"
      >
        <app-icon name="package" [size]="16" slot="icon"></app-icon>
        Albarán de embalaje
      </app-button>
    </div>

    <div class="flex gap-2">
      <app-button
        *ngIf="canCancelOrder()"
        variant="danger"
        size="sm"
        (clicked)="onCancelOrder()"
        [disabled]="isLoading"
      >
        <app-icon name="x-circle" [size]="16" slot="icon"></app-icon>
        Cancelar pedido
      </app-button>

      <app-button
        *ngIf="canRefundOrder()"
        variant="secondary"
        size="sm"
        (clicked)="onRefundOrder()"
        [disabled]="isLoading"
      >
        <app-icon name="refresh-cw" [size]="16" slot="icon"></app-icon>
        Orden de reembolso
      </app-button>

      <app-button
        variant="primary"
        size="sm"
        (clicked)="onUpdateOrder()"
        [disabled]="isLoading || isUpdating || updateForm.invalid"
      >
        <app-icon name="save" [size]="16" slot="icon"></app-icon>
        {{ isUpdating ? "Updating..." : "Update Order" }}
      </app-button>
    </div>
  </div>
</app-modal>

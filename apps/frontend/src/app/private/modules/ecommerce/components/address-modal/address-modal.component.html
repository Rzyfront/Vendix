<app-modal
    [isOpen]="isOpen"
    (isOpenChange)="isOpenChange.emit($event)"
    (cancel)="close()"
    [title]="title"
    size="md"
>
    <!-- Body -->
    <div class="modal-body">
        <!-- Error Message -->
        @if (error_message) {
        <div class="error-message">
            <app-icon name="alert-circle" [size]="18"></app-icon>
            {{ error_message }}
        </div>
        }

        <form [formGroup]="address_form" (ngSubmit)="save()">
            <!-- Address Type -->
            <div class="form-group">
                <app-selector
                    label="Tipo de dirección"
                    formControlName="type"
                    placeholder="Seleccionar"
                    [options]="address_type_options"
                    [required]="true">
                </app-selector>
            </div>

            <!-- Address Line 1 -->
            <div class="form-group">
                <app-input
                    label="Dirección (línea 1)"
                    formControlName="address_line1"
                    placeholder="Calle, número, apartamento"
                    [control]="address_form.get('address_line1')"
                    [required]="true">
                </app-input>
            </div>

            <!-- Address Line 2 -->
            <div class="form-group">
                <app-input
                    label="Dirección (línea 2)"
                    formControlName="address_line2"
                    placeholder="Apartamento, suite, etc. (opcional)">
                </app-input>
            </div>

            <!-- State/Province and Country -->
            <div class="form-row">
                @if (address_form.value.country_code === 'CO') {
                    <div class="form-group">
                        <app-selector
                            label="Departamento"
                            formControlName="state_province"
                            placeholder="{{ loading_departments ? 'Cargando...' : 'Seleccionar' }}"
                            [options]="department_options"
                            [disabled]="loading_departments"
                            [required]="true">
                        </app-selector>
                    </div>
                } @else {
                    <div class="form-group">
                        <app-input
                            label="Estado/Provincia"
                            formControlName="state_province"
                            placeholder="Estado o provincia">
                        </app-input>
                    </div>
                }

                <div class="form-group">
                    <app-selector
                        label="País"
                        formControlName="country_code"
                        [options]="country_options"
                        [required]="true">
                    </app-selector>
                </div>
            </div>

            <!-- City -->
            @if (address_form.value.country_code === 'CO') {
                <div class="form-group">
                    <app-selector
                        label="Ciudad"
                        formControlName="city"
                        placeholder="{{ loading_cities ? 'Cargando...' : 'Seleccionar' }}"
                        [options]="city_options"
                        [disabled]="loading_cities || !address_form.value.state_province"
                        [required]="true">
                    </app-selector>
                </div>
            } @else {
                <div class="form-group">
                    <app-input
                        label="Ciudad"
                        formControlName="city"
                        placeholder="Ciudad"
                        [control]="address_form.get('city')"
                        [required]="true">
                    </app-input>
                </div>
            }

            <!-- Postal Code and Phone -->
            <div class="form-row">
                <div class="form-group">
                    <app-input
                        label="Código postal"
                        formControlName="postal_code"
                        placeholder="Código postal">
                    </app-input>
                </div>

                <div class="form-group">
                    <app-input
                        label="Teléfono"
                        type="tel"
                        formControlName="phone_number"
                        placeholder="+57 300 123 4567"
                        [control]="address_form.get('phone_number')">
                    </app-input>
                </div>
            </div>

            <!-- Is Primary -->
            <div class="form-group toggle-group">
                <app-toggle
                    formControlName="is_primary"
                    label="Establecer como dirección principal">
                </app-toggle>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <div slot="footer">
        <div class="flex items-center justify-end gap-3 p-3 bg-gray-50 rounded-b-xl border-t border-gray-100">
            <app-button variant="outline" (clicked)="close()" [disabled]="is_saving">
                Cancelar
            </app-button>
            <app-button
                variant="primary"
                (clicked)="save()"
                [loading]="is_saving"
                [disabled]="is_saving || address_form.invalid"
            >
                {{ mode === 'create' ? 'Crear dirección' : 'Guardar cambios' }}
            </app-button>
        </div>
    </div>
</app-modal>

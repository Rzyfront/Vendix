<div class="cart-page">
    <h1>Mi Carrito</h1>

    @if (is_loading) {
    <div class="loading">
        <div class="spinner"></div>
        <p>Cargando carrito...</p>
    </div>
    } @else if (!cart || cart.items.length === 0) {
    <div class="empty-cart">
        <app-icon name="shopping-cart" [size]="64" class="text-muted"></app-icon>
        <h2>Tu carrito está vacío</h2>
        <p>Agrega productos para comenzar tu compra</p>
        <button class="primary-btn" (click)="continueShopping()">
            Ver productos
        </button>
    </div>
    } @else {
    <div class="cart-content">
        <div class="cart-items">
            @for (item of cart.items; track item.id) {
            <div class="cart-item" [class.updating]="updating_item_id === item.id">
                <div class="item-image">
                    @if (item.product.image_url) {
                    <img [src]="item.product.image_url" [alt]="item.product.name">
                    } @else {
                    <div class="no-image">
                        <app-icon name="image" [size]="24" class="text-muted"></app-icon>
                    </div>
                    }
                </div>

                <div class="item-details">
                    <h3>{{ item.product.name }}</h3>
                    @if (item.variant) {
                    <span class="variant">{{ item.variant.name }}</span>
                    }
                    <span class="sku">SKU: {{ item.variant?.sku || item.product.sku }}</span>
                </div>

                <div class="item-price">
                    <span class="price">{{ item.unit_price | currency }}</span>
                    <span class="tax-note">Imp. incl.</span>
                </div>

                <div class="item-quantity">
                    <app-quantity-control [value]="item.quantity" [min]="1" [size]="'md'"
                        [disabled]="updating_item_id === item.id"
                        (valueChange)="updateQuantity(item, $event)"></app-quantity-control>
                </div>

                <div class="item-total">
                    {{ item.total_price | currency }}
                </div>

                <button class="remove-btn" (click)="removeItem(item)" title="Eliminar">
                    <app-icon name="trash-2" [size]="18"></app-icon>
                </button>
            </div>
            }
        </div>

        <div class="cart-summary">
            <div class="summary-card">
                <h3>Resumen del pedido</h3>

                <div class="summary-row">
                    <span>Subtotal ({{ cart.item_count }} productos)</span>
                    <span>{{ cart.subtotal | currency }}</span>
                </div>

                <div class="summary-row">
                    <span>Envío</span>
                    <span class="free">Por calcular</span>
                </div>

                <hr>

                <div class="summary-row total">
                    <span>Total</span>
                    <span>{{ cart.subtotal | currency }}</span>
                </div>

                <button class="checkout-btn" (click)="proceedToCheckout()">
                    @if (!is_authenticated) {
                    Iniciar sesión para comprar
                    } @else {
                    Finalizar compra
                    }
                </button>

                <button class="continue-btn" (click)="continueShopping()">
                    Seguir comprando
                </button>
            </div>
        </div>
    </div>
    }

    @if (recommendedProducts().length > 0) {
    <app-product-carousel title="Agrega ofertas imperdibles a tu compra" [products]="recommendedProducts()"
        (quick_view)="onQuickView($event)" (add_to_cart)="onAddToCartFromSlider($event)" />
    }

    <app-product-quick-view-modal [isOpen]="quickViewOpen" [productSlug]="selectedProductSlug"
        (closed)="quickViewOpen = false" (addedToCart)="onAddToCartFromSlider($event)" />
</div>
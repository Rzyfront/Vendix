<div class="checkout-page">
    <h1>Finalizar Compra</h1>

    <!-- Steps indicator -->
    <div class="steps">
        <div class="step" [class.active]="step >= 1" [class.completed]="step > 1">
            <span class="step-number">1</span>
            <span class="step-label">Dirección</span>
        </div>
        <div class="step-line" [class.completed]="step > 1"></div>
        <div class="step" [class.active]="step >= 2" [class.completed]="step > 2">
            <span class="step-number">2</span>
            <span class="step-label">Pago</span>
        </div>
        <div class="step-line" [class.completed]="step > 2"></div>
        <div class="step" [class.active]="step >= 3">
            <span class="step-number">3</span>
            <span class="step-label">Confirmar</span>
        </div>
    </div>

    @if (is_loading) {
    <div class="loading">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>
    } @else {
    <div class="checkout-content">
        <div class="checkout-main">
            <!-- Step 1: Address -->
            @if (step === 1) {
            <div class="checkout-section">
                <h2>Dirección de Envío</h2>

                @if (addresses.length > 0) {
                <div class="address-list">
                    @for (addr of addresses; track addr.id) {
                    <div class="address-card" [class.selected]="selected_address_id === addr.id && !use_new_address"
                        (click)="selectAddress(addr.id)">
                        <div class="address-radio">
                            <span class="radio"
                                [class.checked]="selected_address_id === addr.id && !use_new_address"></span>
                        </div>
                        <div class="address-info">
                            <p class="address-line">{{ addr.address_line1 }}</p>
                            @if (addr.address_line2) {
                            <p class="address-line">{{ addr.address_line2 }}</p>
                            }
                            <p class="address-city">{{ addr.city }}, {{ addr.state_province }}</p>
                            <p class="address-phone">Tel: {{ addr.phone_number }}</p>
                        </div>
                    </div>
                    }

                    <div class="address-card new" [class.selected]="use_new_address" (click)="selectNewAddress()">
                        <div class="address-radio">
                            <span class="radio" [class.checked]="use_new_address"></span>
                        </div>
                        <div class="address-info">
                            <i class="pi pi-plus"></i>
                            <span>Agregar nueva dirección</span>
                        </div>
                    </div>
                </div>
                }

                @if (use_new_address) {
                <form [formGroup]="address_form" class="address-form">
                    <app-input label="Dirección" formControlName="address_line1" placeholder="Calle y número"
                        [control]="address_form.get('address_line1')" [required]="true"></app-input>

                    <app-input label="Apartamento, oficina, etc. (opcional)" formControlName="address_line2"
                        placeholder="Apto, piso, oficina"></app-input>

                    <div class="form-row">
                        <app-selector
                            label="País"
                            formControlName="country_code"
                            [options]="countryOptions"
                            placeholder="Selecciona un país"
                            [errorText]="getFieldError('country_code')"
                            [required]="true"
                        ></app-selector>

                        <app-selector
                            label="Departamento/Estado"
                            formControlName="state_province"
                            [options]="departmentOptions"
                            [placeholder]="loading_departments ? 'Cargando...' : 'Selecciona un departamento'"
                            [disabled]="loading_departments || departmentOptions.length === 0"
                            [errorText]="getFieldError('state_province')"
                        ></app-selector>
                    </div>

                    <div class="form-row">
                        <app-selector
                            label="Ciudad"
                            formControlName="city"
                            [options]="cityOptions"
                            [placeholder]="loading_cities ? 'Cargando...' : 'Selecciona una ciudad'"
                            [disabled]="loading_cities || cityOptions.length === 0"
                            [errorText]="getFieldError('city')"
                            [required]="true"
                        ></app-selector>

                        <app-input label="Código Postal" formControlName="postal_code"
                            placeholder="Código postal"></app-input>
                    </div>

                    <app-input label="Teléfono" formControlName="phone_number" type="tel"
                        placeholder="Teléfono de contacto" [control]="address_form.get('phone_number')"
                        [required]="true"></app-input>

                    <!-- Save address checkbox -->
                    <div class="save-address-option">
                        <label class="checkbox-label">
                            <input type="checkbox" [(ngModel)]="save_new_address" [ngModelOptions]="{standalone: true}">
                            <span class="checkbox-text">Guardar esta dirección para futuras compras</span>
                        </label>
                    </div>
                </form>
                }
            </div>
            }

            <!-- Step 2: Payment -->
            @if (step === 2) {
            <div class="checkout-section">
                <h2>Opciones de Envío</h2>
                @if (shipping_options.length > 0) {
                <div class="payment-list" style="margin-bottom: 2rem;">
                    @for (option of shipping_options; track option.id) {
                    <div class="payment-card" [class.selected]="selected_shipping_option_id === option.id"
                        (click)="selectShippingMethod(option, option.cost)">
                        <div class="payment-radio">
                            <span class="radio" [class.checked]="selected_shipping_option_id === option.id"></span>
                        </div>
                        <div class="payment-info" style="flex: 1;">
                            <span class="payment-name">{{ option.method_name }}</span>
                            <span class="payment-type">{{ option.description }}</span>
                        </div>
                        <div class="payment-price" style="font-weight: bold;">
                            {{ option.cost === 0 ? 'Gratis' : (option.cost | currency) }}
                        </div>
                    </div>
                    }
                </div>
                } @else {
                <div class="error-message" style="margin-bottom: 2rem;">
                    <i class="pi pi-exclamation-triangle"></i>
                    No hay opciones de envío disponibles para esta ubicación. Por favor revisa tu dirección.
                </div>
                }

                <h2>Método de Pago</h2>

                <div class="payment-list">
                    @for (method of payment_methods; track method.id) {
                    <div class="payment-card" [class.selected]="selected_payment_method_id === method.id"
                        (click)="selectPaymentMethod(method.id)">
                        <div class="payment-radio">
                            <span class="radio" [class.checked]="selected_payment_method_id === method.id"></span>
                        </div>
                        @if (method.logo_url) {
                        <img [src]="method.logo_url" [alt]="method.name" class="payment-logo">
                        }
                        <div class="payment-info">
                            <span class="payment-name">{{ method.name }}</span>
                            <span class="payment-type">{{ method.type }}</span>
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- Step 3: Confirm -->
            @if (step === 3) {
            <div class="checkout-section">
                <h2>Confirmar Pedido</h2>

                <div class="confirm-details">
                    <div class="confirm-block">
                        <h3>Dirección de Envío</h3>
                        @if (use_new_address) {
                        <p>{{ address_form.value.address_line1 }}</p>
                        @if (address_form.value.address_line2) {
                        <p>{{ address_form.value.address_line2 }}</p>
                        }
                        <p>{{ getSelectedCityName() }}, {{ getSelectedDepartmentName() }}</p>
                        <p>{{ getSelectedCountryName() }}</p>
                        @if (address_form.value.postal_code) {
                        <p>Código Postal: {{ address_form.value.postal_code }}</p>
                        }
                        <p>Tel: {{ address_form.value.phone_number }}</p>
                        } @else {
                        @for (addr of addresses; track addr.id) {
                        @if (addr.id === selected_address_id) {
                        <p>{{ addr.address_line1 }}</p>
                        @if (addr.address_line2) {
                        <p>{{ addr.address_line2 }}</p>
                        }
                        <p>{{ addr.city }}, {{ addr.state_province }}</p>
                        <p>Tel: {{ addr.phone_number }}</p>
                        }
                        }
                        }
                    </div>

                    <div class="confirm-block">
                        <h3>Método de Pago</h3>
                        @for (method of payment_methods; track method.id) {
                        @if (method.id === selected_payment_method_id) {
                        <p>{{ method.name }}</p>
                        }
                        }
                    </div>

                    <div class="notes-section">
                        <label>Notas del pedido (opcional)</label>
                        <textarea [(ngModel)]="notes"
                            placeholder="Instrucciones especiales para la entrega..."></textarea>
                    </div>
                </div>
            </div>
            }

            @if (error_message) {
            <div class="error-message">
                <i class="pi pi-exclamation-circle"></i>
                {{ error_message }}
            </div>
            }

            <div class="checkout-actions">
                @if (step > 1) {
                <app-button variant="outline" (clicked)="prevStep()">
                    <app-icon slot="icon" name="arrow-left" [size]="16"></app-icon>
                    Anterior
                </app-button>
                } @else {
                <app-button variant="outline" (clicked)="goToCart()">
                    <app-icon slot="icon" name="arrow-left" [size]="16"></app-icon>
                    Volver al carrito
                </app-button>
                }

                @if (step < 3) {
                <app-button variant="primary" (clicked)="nextStep()">
                    Continuar
                    <app-icon slot="icon" name="arrow-right" [size]="16"></app-icon>
                </app-button>
                } @else {
                <app-button variant="primary" (clicked)="placeOrder()" [loading]="is_submitting" [disabled]="is_submitting">
                    @if (!is_submitting) {
                    <app-icon slot="icon" name="check" [size]="16"></app-icon>
                    }
                    {{ is_submitting ? 'Procesando...' : 'Confirmar Pedido' }}
                </app-button>
                }
            </div>
        </div>

        <!-- Order Summary -->
        <div class="checkout-summary">
            <div class="summary-card">
                <h3>Resumen</h3>

                @if (cart) {
                <div class="summary-items">
                    @for (item of cart.items; track item.id) {
                    <div class="summary-item">
                        <span class="item-qty">{{ item.quantity }}x</span>
                        <span class="item-name">{{ item.product.name }}</span>
                        <span class="item-price">{{ item.total_price | currency }}</span>
                    </div>
                    }
                </div>

                <hr>

                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>{{ cart.subtotal | currency }}</span>
                </div>
                <div class="summary-row">
                    <span>Envío</span>
                    <span>{{ shipping_cost === 0 ? 'Gratis' : (shipping_cost | currency) }}</span>
                </div>

                <hr>

                <div class="summary-row total">
                    <span>Total</span>
                    <span>{{ (cart.subtotal + shipping_cost) | currency }}</span>
                </div>
                }
            </div>
        </div>
    </div>
    }

    @if (recommendedProducts().length > 0 && !is_submitting) {
    <div class="checkout-offers">
        <app-product-carousel title="Agrega ofertas imperdibles a tu compra" [products]="recommendedProducts()"
            (quick_view)="onQuickView($event)" (add_to_cart)="onAddToCartFromSlider($event)" />
    </div>
    }

    <app-product-quick-view-modal [isOpen]="quickViewOpen" [productSlug]="selectedProductSlug"
        (closed)="quickViewOpen = false" (addedToCart)="onAddToCartFromSlider($event)" />
</div>
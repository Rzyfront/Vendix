<div class="account-page">
    <!-- Account Header -->
    <div class="account-header">
        <div class="header-content">
            @if (profile && profile.avatar_url) {
                <div class="avatar">
                    <img [src]="profile.avatar_url" [alt]="profile.first_name || 'Usuario'" />
                </div>
            } @else {
                <div class="avatar avatar-placeholder">
                    <app-icon name="user" [size]="24"></app-icon>
                </div>
            }
            <div class="header-info">
                <h1>Mi Cuenta</h1>
                <p class="header-email">{{ profile?.email }}</p>
            </div>
        </div>
        <app-button variant="outline-danger" (clicked)="logout()">
            <app-icon slot="icon" name="log-out" [size]="18"></app-icon>
            Cerrar sesión
        </app-button>
    </div>

    <!-- Navigation Tabs -->
    <nav class="account-nav">
        <a routerLink="/account" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">
            <app-icon name="user" [size]="24"></app-icon>
            Perfil
        </a>
        <a routerLink="/account/orders" routerLinkActive="active">
            <app-icon name="list" [size]="18"></app-icon>
            Mis Pedidos
        </a>
    </nav>

    @if (success_message) {
        <div class="success-message">
            <app-icon name="check-circle" [size]="20"></app-icon>
            {{ success_message }}
        </div>
    }

    @if (error_message) {
        <div class="error-message">
            <app-icon name="alert-circle" [size]="20"></app-icon>
            {{ error_message }}
        </div>
    }

    @if (is_loading) {
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    } @else {
        <div class="account-grid">
            <!-- Main Column: Personal Info + Security -->
            <div class="main-column">
                <!-- Personal Info Section -->
                <section class="account-section">
                    <div class="section-header">
                        <h2>Información Personal</h2>
                    </div>
                    <form [formGroup]="profile_form" (ngSubmit)="saveProfile()">
                        <div class="form-row">
                            <div class="form-group">
                                <app-input label="Nombre" formControlName="first_name" placeholder="Tu nombre" [control]="profile_form.get('first_name')"></app-input>
                            </div>
                            <div class="form-group">
                                <app-input label="Apellido" formControlName="last_name" placeholder="Tu apellido" [control]="profile_form.get('last_name')"></app-input>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <app-input label="Teléfono" type="tel" formControlName="phone" placeholder="Solo números" [control]="profile_form.get('phone')"></app-input>
                            </div>
                            <div class="form-group">
                                <app-input label="Email" type="email" [value]="profile?.email || ''" [disabled]="true"></app-input>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <app-selector
                                    label="Tipo de Documento"
                                    formControlName="document_type"
                                    placeholder="Seleccionar"
                                    [options]="document_type_options">
                                </app-selector>
                            </div>
                            <div class="form-group">
                                <app-input label="Número de Documento" formControlName="document_number" placeholder="Solo números" [control]="profile_form.get('document_number')"></app-input>
                            </div>
                        </div>
                        <div class="form-actions">
                            <app-button type="submit" variant="primary" [loading]="is_saving" [disabled]="is_saving || !profile_form.valid">
                                @if (!is_saving) {
                                    <app-icon slot="icon" name="save" [size]="18"></app-icon>
                                }
                                {{ is_saving ? 'Guardando...' : 'Guardar cambios' }}
                            </app-button>
                        </div>
                    </form>
                </section>

                <!-- Security Section -->
                <section class="account-section">
                    <div class="section-header">
                        <h2>Seguridad</h2>
                    </div>
                    @if (!show_password_form) {
                        <div class="security-actions">
                            <p class="security-hint">Cambiar tu contraseña regularmente ayuda a proteger tu cuenta.</p>
                            <app-button variant="outline" (clicked)="show_password_form = true">
                                <app-icon slot="icon" name="key" [size]="18"></app-icon>
                                Cambiar contraseña
                            </app-button>
                        </div>
                    } @else {
                        <form [formGroup]="password_form" (ngSubmit)="changePassword()">
                            <div class="form-group">
                                <app-input label="Contraseña actual" type="password" formControlName="current_password" placeholder="Contraseña actual" [control]="password_form.get('current_password')"></app-input>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <app-input label="Nueva contraseña" type="password" formControlName="new_password" placeholder="Nueva contraseña" [control]="password_form.get('new_password')"></app-input>
                                </div>
                                <div class="form-group">
                                    <app-input label="Confirmar contraseña" type="password" formControlName="confirm_password" placeholder="Confirmar" [control]="password_form.get('confirm_password')"></app-input>
                                </div>
                            </div>
                            <div class="form-actions">
                                <app-button type="button" variant="ghost" (clicked)="show_password_form = false; password_form.reset()">
                                    Cancelar
                                </app-button>
                                <app-button type="submit" variant="primary" [loading]="is_changing_password" [disabled]="is_changing_password || !password_form.valid">
                                    {{ is_changing_password ? 'Cambiando...' : 'Cambiar contraseña' }}
                                </app-button>
                            </div>
                        </form>
                    }
                </section>
            </div>

            <!-- Side Column: Addresses -->
            <div class="side-column">
                <section class="account-section addresses-section">
                    <div class="section-header">
                        <h2>Mis Direcciones</h2>
                        <app-button variant="ghost" size="sm" (clicked)="openAddressModal('create')" title="Agregar dirección">
                            <app-icon name="plus" [size]="18"></app-icon>
                        </app-button>
                    </div>

                    @if (!profile || !profile.addresses || profile.addresses.length === 0) {
                        <div class="empty-state">
                            <app-icon name="map-pin" [size]="32"></app-icon>
                            <p>No tienes direcciones guardadas</p>
                            <app-button variant="outline" (clicked)="openAddressModal('create')">
                                Agregar dirección
                            </app-button>
                        </div>
                    } @else {
                        <div class="address-list">
                            @for (addr of profile.addresses; track addr.id) {
                                <div class="address-card" [class.primary]="addr.is_primary">
                                    <div class="address-icon">
                                        <app-icon name="map-pin" [size]="32"></app-icon>
                                    </div>
                                    <div class="address-content">
                                        <div class="address-header">
                                            <span class="address-type">{{ getAddressTypeLabel(addr.type) }}</span>
                                            @if (addr.is_primary) {
                                                <span class="primary-badge">
                                                    <app-icon name="star" [size]="14"></app-icon>
                                                    Principal
                                                </span>
                                            }
                                        </div>
                                        <div class="address-body">
                                            <p class="address-line">{{ addr.address_line1 }}</p>
                                            @if (addr.address_line2) {
                                                <p class="address-line">{{ addr.address_line2 }}</p>
                                            }
                                            <div class="address-location">
                                                <span class="location-item">
                                                    <app-icon name="building-2" [size]="14"></app-icon>
                                                    {{ addr.city }}
                                                </span>
                                                @if (addr.state_province) {
                                                    <span class="location-separator">•</span>
                                                    <span class="location-item">{{ addr.state_province }}</span>
                                                }
                                            </div>
                                            @if (addr.phone_number) {
                                                <p class="address-phone">
                                                    <app-icon name="phone" [size]="14"></app-icon>
                                                    {{ addr.phone_number }}
                                                </p>
                                            }
                                        </div>
                                    </div>
                                    <div class="address-actions">
                                        @if (!addr.is_primary) {
                                            <app-button variant="ghost" size="sm" (clicked)="setAddressPrimary(addr.id)" title="Establecer como principal">
                                                <app-icon name="star" [size]="18"></app-icon>
                                            </app-button>
                                        }
                                        <app-button variant="ghost" size="sm" (clicked)="openAddressModal('edit', addr)" title="Editar">
                                            <app-icon name="edit" [size]="16"></app-icon>
                                        </app-button>
                                        <app-button variant="outline-danger" size="sm" (clicked)="deleteAddress(addr.id)" title="Eliminar">
                                            <app-icon name="trash" [size]="16"></app-icon>
                                        </app-button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </section>
            </div>
        </div>
    }

    <!-- Address Modal -->
    <app-address-modal
        [(isOpen)]="show_address_modal"
        [mode]="address_modal_mode"
        [address]="editing_address"
        (saved)="onAddressSaved($event)"
    />
</div>

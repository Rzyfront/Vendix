<app-modal
  [isOpen]="isOpen"
  [size]="'lg'"
  [title]="customer ? 'Detalles del Cliente' : 'Cargando...'"
  [subtitle]="customer ? `@${customer.username}` : ''"
  (close)="onClose()"
>
  <!-- Loading State -->
  <div *ngIf="loading" class="flex items-center justify-center py-12">
    <div
      class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
    ></div>
  </div>

  <!-- Customer Details -->
  <div *ngIf="!loading && customer" class="space-y-6">
    <!-- Customer Header -->
    <div class="flex items-center space-x-4 pb-6 border-b border-gray-200">
      <div
        class="h-16 w-16 rounded-full bg-blue-100 flex items-center justify-center"
      >
        <span class="text-xl font-semibold text-blue-600">
          {{ getCustomerInitials() }}
        </span>
      </div>
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-gray-900">
          {{ customer.first_name }} {{ customer.last_name }}
        </h3>
        <p class="text-gray-500">@{{ customer.username }}</p>
      </div>
      <div class="text-right">
        <span
          class="inline-flex px-3 py-1 text-sm font-semibold rounded-full"
          [ngClass]="{
            'bg-green-100 text-green-800':
              getStatusColor(customer.state) === 'green',
            'bg-yellow-100 text-yellow-800':
              getStatusColor(customer.state) === 'yellow',
            'bg-red-100 text-red-800': getStatusColor(customer.state) === 'red',
            'bg-gray-100 text-gray-800':
              getStatusColor(customer.state) === 'gray',
          }"
        >
          {{ getStatusLabel(customer.state) }}
        </span>
      </div>
    </div>

    <!-- View Mode -->
    <div *ngIf="!editing" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Contact Information -->
      <div class="space-y-4">
        <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
          Información de Contacto
        </h4>

        <div>
          <label class="block text-sm font-medium text-gray-500">Email</label>
          <p class="text-gray-900">{{ customer.email }}</p>
          <span
            *ngIf="customer.email_verified"
            class="inline-flex items-center text-xs text-green-600 mt-1"
          >
            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              ></path>
            </svg>
            Verificado
          </span>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Teléfono</label
          >
          <p class="text-gray-900">{{ formatPhone(customer.phone) }}</p>
        </div>
      </div>

      <!-- Personal Information -->
      <div class="space-y-4">
        <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
          Información Personal
        </h4>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Nombre de Usuario</label
          >
          <p class="text-gray-900">@{{ customer.username }}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Nombre Completo</label
          >
          <p class="text-gray-900">
            {{ customer.first_name }} {{ customer.last_name || "" }}
          </p>
        </div>

        <div *ngIf="customer.document_type || customer.document_number">
          <label class="block text-sm font-medium text-gray-500"
            >Documento</label
          >
          <p class="text-gray-900">
            {{ customer.document_type }} {{ customer.document_number }}
          </p>
        </div>
      </div>

      <!-- Account Information -->
      <div class="space-y-4">
        <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
          Información de Cuenta
        </h4>

        <div>
          <label class="block text-sm font-medium text-gray-500">Estado</label>
          <p class="text-gray-900">{{ getStatusLabel(customer.state) }}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Email Verificado</label
          >
          <p class="text-gray-900">
            {{ customer.email_verified ? "Sí" : "No" }}
          </p>
        </div>
      </div>

      <!-- Timestamps -->
      <div class="space-y-4">
        <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
          Fechas Importantes
        </h4>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Fecha de Creación</label
          >
          <p class="text-gray-900">{{ formatDate(customer.created_at) }}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-500"
            >Última Actualización</label
          >
          <p class="text-gray-900">{{ formatDate(customer.updated_at) }}</p>
        </div>

        <div *ngIf="customer.last_login">
          <label class="block text-sm font-medium text-gray-500"
            >Último Login</label
          >
          <p class="text-gray-900">{{ formatDate(customer.last_login) }}</p>
        </div>
      </div>
    </div>

    <!-- Edit Mode -->
    <div *ngIf="editing" class="space-y-6">
      <form (ngSubmit)="saveChanges()" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- First Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nombre</label
            >
            <input
              type="text"
              [(ngModel)]="editData.first_name"
              name="first_name"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <!-- Last Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Apellido</label
            >
            <input
              type="text"
              [(ngModel)]="editData.last_name"
              name="last_name"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <!-- Phone -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Teléfono</label
            >
            <input
              type="tel"
              [(ngModel)]="editData.phone"
              name="phone"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <!-- Document Type -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tipo de Documento</label
            >
            <select
              [(ngModel)]="editData.document_type"
              name="document_type"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Seleccionar...</option>
              <option value="DNI">DNI</option>
              <option value="Passport">Pasaporte</option>
              <option value="Cédula">Cédula</option>
              <option value="RUT">RUT</option>
            </select>
          </div>

          <!-- Document Number -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Número de Documento</label
            >
            <input
              type="text"
              [(ngModel)]="editData.document_number"
              name="document_number"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button
            type="button"
            (click)="cancelEditing()"
            [disabled]="loading"
            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors disabled:opacity-50"
          >
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="loading"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 flex items-center gap-2"
          >
            <div
              *ngIf="loading"
              class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"
            ></div>
            {{ loading ? "Guardando..." : "Guardar Cambios" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Footer -->
  <div slot="footer" *ngIf="!loading && customer">
    <div class="flex justify-between items-center">
      <!-- Left Actions -->
      <div class="flex gap-2">
        <button
          *ngIf="!editing"
          (click)="startEditing()"
          class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm"
        >
          Editar
        </button>

        <!-- Status Change Dropdown -->
        <div *ngIf="!editing" class="relative inline-block text-left">
          <button
            type="button"
            class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors text-sm flex items-center gap-2"
          >
            Cambiar Estado
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"
          >
            <div class="py-1">
              <button
                *ngFor="let option of statusOptions"
                (click)="changeStatus(option.value)"
                [disabled]="option.value === customer.state"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {{ option.label }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Actions -->
      <button
        (click)="onClose()"
        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors"
      >
        Cerrar
      </button>
    </div>
  </div>
</app-modal>

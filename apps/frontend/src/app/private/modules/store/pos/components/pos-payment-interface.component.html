<app-modal
  [isOpen]="isOpen"
  [size]="'lg'"
  (closed)="onModalClosed()"
  [showCloseButton]="true"
  [title]="'Procesar Pago'"
  [subtitle]="'Selecciona un método de pago para completar la venta'"
>
  <!-- Resumen del Pedido -->
  <div class="mb-6 animate-slide-in">
    <app-card [shadow]="'md'" [customClasses]="'payment-summary-enhanced'">
      <div class="p-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span
                class="text-sm font-medium text-[var(--color-text-secondary)]"
                >Subtotal</span
              >
              <span
                class="text-sm font-semibold text-[var(--color-text-primary)]"
              >
                ${{ cartState?.summary?.subtotal || 0 | number: "1.2-2" }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span
                class="text-sm font-medium text-[var(--color-text-secondary)]"
                >Impuestos</span
              >
              <span
                class="text-sm font-semibold text-[var(--color-text-primary)]"
              >
                ${{ cartState?.summary?.taxAmount || 0 | number: "1.2-2" }}
              </span>
            </div>
          </div>
          <div class="space-y-3">
            <div
              *ngIf="(cartState?.summary?.discountAmount ?? 0) > 0"
              class="flex justify-between items-center"
            >
              <span
                class="text-sm font-medium text-[var(--color-text-secondary)]"
                >Descuento</span
              >
              <span class="text-sm font-semibold text-[var(--color-error)]">
                -${{ cartState?.summary?.discountAmount | number: "1.2-2" }}
              </span>
            </div>
            <div
              class="flex justify-between items-center pt-3 border-t border-[var(--color-border)]"
            >
              <span class="text-base font-bold text-[var(--color-text-primary)]"
                >Total</span
              >
              <span class="text-xl font-bold text-[var(--color-primary)]">
                ${{ cartState?.summary?.total || 0 | number: "1.2-2" }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </app-card>
  </div>

  <!-- Opciones de Pago -->
  <div class="mb-6 animate-slide-in" style="animation-delay: 0.1s">
    <h3 class="section-header-enhanced text-xl mb-6 flex items-center gap-3">
      <app-icon
        name="credit-card"
        [size]="24"
        color="var(--color-primary)"
      ></app-icon>
      Opciones de Venta
    </h3>

    <!-- Opción de Venta a Crédito -->
    <div class="mb-6">
      <div
        (click)="processCreditSale()"
        class="payment-method-card credit-sale-card cursor-pointer p-5 text-center"
        role="button"
        tabindex="0"
        (keydown.enter)="processCreditSale()"
        (keydown.space)="processCreditSale()"
        [attr.aria-label]="'Procesar venta a crédito'"
      >
        <div class="flex flex-col items-center">
          <app-icon
            name="calendar"
            [size]="40"
            color="var(--color-warning)"
            class="mb-3"
          ></app-icon>
          <span class="text-base font-semibold text-[var(--color-text-primary)]"
            >Venta a Crédito</span
          >
          <span class="text-sm text-[var(--color-text-secondary)] mt-1"
            >Generar orden sin pago inmediato</span
          >
        </div>
      </div>
    </div>

    <!-- Métodos de Pago -->
    <div>
      <h4 class="section-header-enhanced text-lg mb-4">Pagos Inmediatos</h4>
      <div class="grid grid-cols-2 gap-4">
        <div
          *ngFor="let method of paymentMethods; let i = index"
          (click)="selectPaymentMethod(method)"
          [class]="getPaymentMethodClasses(method)"
          class="payment-method-card cursor-pointer p-5 text-center"
          role="button"
          tabindex="0"
          (keydown.enter)="selectPaymentMethod(method)"
          (keydown.space)="selectPaymentMethod(method)"
          [attr.aria-label]="'Seleccionar método de pago ' + method.name"
          [attr.aria-pressed]="paymentState.selectedMethod?.id === method.id"
          style="animation-delay: {{ 0.2 + i * 0.05 }}s"
        >
          <div class="flex flex-col items-center">
            <app-icon
              [name]="method.icon"
              [size]="36"
              [color]="
                paymentState.selectedMethod?.id === method.id
                  ? 'var(--color-primary)'
                  : 'var(--color-text-secondary)'
              "
              class="mb-3"
            ></app-icon>
            <span
              class="text-sm font-semibold text-[var(--color-text-primary)]"
            >
              {{ method.name }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de Detalles de Pago -->
  <div
    *ngIf="paymentState.selectedMethod"
    class="mb-6 animate-slide-in"
    style="animation-delay: 0.3s"
  >
    <app-card [shadow]="'md'" ] [customClasses]="'payment-details-enhanced'">
      <div class="p-6">
        <h4 class="section-header-enhanced text-lg mb-6">
          Detalles de Pago - {{ paymentState.selectedMethod.name }}
        </h4>

        <!-- Pago en Efectivo -->
        <div
          *ngIf="paymentState.selectedMethod.type === 'cash'"
          class="space-y-6"
        >
          <div>
            <label
              class="block text-base font-semibold text-[var(--color-text-primary)] mb-3"
              for="cashReceived"
            >
              Monto Recibido
            </label>
            <div class="enhanced-cash-input p-1 flex items-center">
              <span
                class="pl-4 pr-2 text-lg font-semibold text-[var(--color-text-secondary)]"
              >
                $
              </span>
              <input
                id="cashReceived"
                type="number"
                [formControl]="cashReceivedControl"
                class="flex-1 py-3 px-2 text-lg font-semibold text-[var(--color-text-primary)] placeholder-[var(--color-text-muted)]"
                placeholder="0.00"
                step="0.01"
                (input)="calculateChange()"
                [attr.aria-label]="'Monto recibido en efectivo'"
              />
            </div>
          </div>

          <!-- Botones de Montos Rápidos -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-text-secondary)] mb-3"
            >
              Montos Rápidos
            </label>
            <div class="grid grid-cols-4 gap-3">
              <button
                *ngFor="let amount of quickCashAmounts"
                type="button"
                (click)="setCashAmount(amount)"
                class="quick-amount-btn py-3 text-base font-medium"
                [attr.aria-label]="'Establecer monto $' + amount"
              >
                ${{ amount }}
              </button>
            </div>
          </div>

          <!-- Visualización de Cambio -->
          <div
            *ngIf="paymentState.change > 0"
            class="change-display-enhanced"
            role="status"
            [attr.aria-live]="'polite'"
          >
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <app-icon
                  name="coins"
                  [size]="20"
                  color="var(--color-success)"
                ></app-icon>
                <span
                  class="text-base font-semibold text-[var(--color-success)]"
                  >Cambio</span
                >
              </div>
              <span
                class="text-xl font-bold text-[var(--color-success)] pulse-success"
              >
                ${{ paymentState.change | number: "1.2-2" }}
              </span>
            </div>
          </div>
        </div>

        <!-- Pago con Tarjeta/Transferencia/Billetera Digital -->
        <div
          *ngIf="paymentState.selectedMethod.requiresReference"
          class="space-y-4"
        >
          <app-input
            [formControl]="referenceControl"
            [label]="paymentState.selectedMethod.referenceLabel || 'Referencia'"
            [placeholder]="
              paymentState.selectedMethod.referenceLabel ||
              'Ingresa la referencia'
            "
            [size]="'lg'"
            [error]="getReferenceError()"
            [attr.aria-required]="'true'"
          >
          </app-input>
        </div>
      </div>
    </app-card>
  </div>

  <!-- Teclado Numérico -->
  <div
    *ngIf="paymentState.selectedMethod?.type === 'cash'"
    class="mb-6 animate-slide-in"
    style="animation-delay: 0.4s"
  >
    <app-card [shadow]="'md'" [customClasses]="'payment-details-enhanced'">
      <div class="p-6">
        <h4 class="section-header-enhanced text-lg mb-4">Teclado Numérico</h4>
        <div class="grid grid-cols-3 gap-3">
          <button
            *ngFor="let num of [7, 8, 9, 4, 5, 6, 1, 2, 3]"
            type="button"
            (click)="appendNumber(num)"
            class="keypad-btn"
            [attr.aria-label]="'Agregar número ' + num"
          >
            {{ num }}
          </button>
          <button
            type="button"
            (click)="appendNumber(0)"
            class="keypad-btn col-span-2"
            [attr.aria-label]="'Agregar cero'"
          >
            0
          </button>
          <button
            type="button"
            (click)="clearCashAmount()"
            class="keypad-btn bg-[var(--color-error)] text-white border-[var(--color-error)] hover:bg-[var(--color-error)]/90 focus:ring-[var(--color-error)]/50"
            [attr.aria-label]="'Limpiar monto'"
          >
            C
          </button>
        </div>
      </div>
    </app-card>
  </div>

  <!-- Botones de Acción -->
  <div slot="footer" class="flex justify-between items-center gap-4">
    <app-button
      variant="outline"
      size="lg"
      (clicked)="onModalClosed()"
      [disabled]="paymentState.isProcessing"
      [customClasses]="'font-medium'"
      [attr.aria-label]="'Cancelar y cerrar modal de pago'"
    >
      <app-icon name="x" [size]="18" slot="icon"></app-icon>
      Cancelar
    </app-button>

    <div class="flex gap-3">
      <app-button
        variant="secondary"
        size="lg"
        (clicked)="saveAsDraft()"
        [disabled]="paymentState.isProcessing"
        [customClasses]="'font-medium'"
        [attr.aria-label]="'Guardar orden como borrador'"
      >
        <app-icon name="save" [size]="18" slot="icon"></app-icon>
        Guardar Borrador
      </app-button>

      <app-button
        variant="primary"
        size="lg"
        (clicked)="processPayment()"
        [loading]="paymentState.isProcessing"
        [disabled]="!canProcessPayment()"
        [customClasses]="'font-semibold'"
        [attr.aria-label]="
          paymentState.selectedMethod?.type === 'cash'
            ? 'Procesar cobro en efectivo'
            : 'Procesar pago con ' + (paymentState.selectedMethod?.name || '')
        "
      >
        <app-icon name="check" [size]="18" slot="icon"></app-icon>
        {{
          paymentState.selectedMethod?.type === "cash"
            ? "Cobrar"
            : "Procesar Pago"
        }}
      </app-button>
    </div>
  </div>
</app-modal>

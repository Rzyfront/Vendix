<app-modal
  [isOpen]="isOpen"
  [size]="'lg'"
  [title]="'Procesar Pago'"
  [subtitle]="'Selecciona método de pago y cliente'"
  (closed)="onModalClosed()"
>
  <!-- Main Content -->
  <div class="payment-content">
    <!-- Resumen Section -->
    <section class="payment-section">
      <div class="section-header">
        <div class="section-indicator"></div>
        <h2 class="section-title">Resumen</h2>
      </div>

      <!-- Product List -->
      <div class="product-list">
        <div *ngFor="let item of cartState?.items" class="product-item">
          <span class="product-name">{{ item.product.name }}</span>
          <span class="product-qty">x{{ item.quantity }}</span>
        </div>
        <div *ngIf="!cartState?.items?.length" class="empty-cart">
          El carrito está vacío
        </div>
      </div>

      <!-- Summary Details -->
      <div class="summary-details">
        <div class="summary-row">
          <span>Productos</span>
          <span class="summary-value">{{ cartState?.summary?.itemCount || 0 }}</span>
        </div>
        <div class="summary-row">
          <span>Cantidad</span>
          <span class="summary-value">{{ cartState?.summary?.totalItems || 0 }}</span>
        </div>
        <div class="summary-row">
          <span>Subtotal</span>
          <span class="summary-value">{{ cartState?.summary?.subtotal || 0 | currency }}</span>
        </div>
        <div class="summary-row">
          <span>Impuestos</span>
          <span class="summary-value">{{ cartState?.summary?.taxAmount || 0 | currency }}</span>
        </div>
        <div *ngIf="(cartState?.summary?.discountAmount ?? 0) > 0" class="summary-row">
          <span>Descuento</span>
          <span class="summary-value discount">-{{ cartState?.summary?.discountAmount | currency }}</span>
        </div>
      </div>

      <!-- Total -->
      <div class="total-section">
        <p class="total-label">Total a Pagar</p>
        <p class="total-amount">{{ cartState?.summary?.total || 0 | currency }}</p>
      </div>
    </section>

    <!-- Método de Pago Section -->
    <section class="payment-section">
      <div class="section-header">
        <app-icon name="credit-card" [size]="16" class="section-icon"></app-icon>
        <h2 class="section-title">Método de Pago</h2>
      </div>

      <div *ngIf="paymentMethods.length > 0; else noPaymentMethods" class="payment-methods-grid">
        <button
          *ngFor="let method of paymentMethods"
          type="button"
          (click)="selectPaymentMethod(method)"
          class="payment-method-btn"
          [class.selected]="paymentState.selectedMethod?.id === method.id"
        >
          <app-icon [name]="method.icon" [size]="24"></app-icon>
          <span class="method-name">{{ method.name }}</span>
        </button>
      </div>

      <ng-template #noPaymentMethods>
        <div class="no-methods">
          <app-icon name="credit-card" [size]="24"></app-icon>
          <p>No hay métodos configurados</p>
          <button class="configure-link" (click)="navigateToSettings()">Configurar ahora</button>
        </div>
      </ng-template>

      <!-- Cash Input (when cash selected) -->
      <div *ngIf="paymentState.selectedMethod?.type === 'cash'" class="cash-section">
        <div class="cash-inputs">
          <div class="cash-input-group">
            <label>Monto Recibido</label>
            <div class="cash-input" [class.error]="isCashAmountInsufficient">
              <span class="currency">{{ currencySymbol() }}</span>
              <input
                type="number"
                [formControl]="cashReceivedControl"
                placeholder="0.00"
                step="0.01"
                (input)="calculateChange()"
              />
            </div>
            <span *ngIf="isCashAmountInsufficient" class="error-text">
              Faltan: {{ missingAmount | currency }}
            </span>
          </div>
          <div class="cash-input-group">
            <label>Cambio</label>
            <div class="change-display">
              <span>{{ paymentState.change | currency }}</span>
              <app-icon name="coins" [size]="18"></app-icon>
            </div>
          </div>
        </div>

        <!-- Quick Amounts -->
        <div class="quick-amounts">
          <button type="button" (click)="setHalfAmount()" class="quick-btn">
            <span>1/2 Pago</span>
            <span class="quick-value">{{ (cartState?.summary?.total || 0) / 2 | currency }}</span>
          </button>
          <button type="button" (click)="setFullAmount()" class="quick-btn primary">
            <span>Total</span>
            <app-icon name="check" [size]="16"></app-icon>
          </button>
        </div>

        <!-- Numeric Keypad -->
        <div class="keypad">
          <button *ngFor="let num of [1, 2, 3, 4, 5, 6, 7, 8, 9]" type="button" (click)="appendNumber(num)" class="keypad-btn">
            {{ num }}
          </button>
          <button type="button" (click)="clearCashAmount()" class="keypad-btn clear">C</button>
          <button type="button" (click)="appendNumber(0)" class="keypad-btn">0</button>
          <button type="button" (click)="backspace()" class="keypad-btn">
            <app-icon name="delete" [size]="20"></app-icon>
          </button>
        </div>
      </div>

      <!-- Reference Input (when required) -->
      <div *ngIf="paymentState.selectedMethod?.requiresReference" class="reference-section">
        <div class="reference-header">
          <app-icon [name]="paymentState.selectedMethod?.icon || 'credit-card'" [size]="28"></app-icon>
          <p>Ingresa el número de referencia</p>
        </div>
        <app-input
          [formControl]="referenceControl"
          [label]="paymentState.selectedMethod?.referenceLabel || 'Referencia'"
          [placeholder]="'Ingresa la referencia'"
          [size]="'lg'"
          [error]="getReferenceError()"
        ></app-input>
      </div>
    </section>

    <!-- Tipo de Venta Section -->
    <section class="payment-section">
      <div class="section-header">
        <app-icon name="users" [size]="16" class="section-icon"></app-icon>
        <h2 class="section-title">Tipo de Venta</h2>
      </div>

      <!-- Sale Type Options -->
      <div class="sale-type-options">
        <!-- Anonymous Sale Option -->
        <button
          *ngIf="allowAnonymousSales"
          type="button"
          class="sale-type-btn"
          [class.selected]="paymentState.isAnonymousSale"
          (click)="toggleAnonymousSale(true)"
        >
          <div class="radio-indicator">
            <div *ngIf="paymentState.isAnonymousSale" class="radio-dot"></div>
          </div>
          <app-icon name="user-x" [size]="20"></app-icon>
          <div class="sale-type-info">
            <span class="sale-type-name">Venta Anónima</span>
            <span class="sale-type-desc">Sin cliente asociado</span>
          </div>
        </button>

        <!-- Customer Sale Option -->
        <button
          type="button"
          class="sale-type-btn"
          [class.selected]="!paymentState.isAnonymousSale"
          (click)="toggleAnonymousSale(false)"
        >
          <div class="radio-indicator">
            <div *ngIf="!paymentState.isAnonymousSale" class="radio-dot"></div>
          </div>
          <app-icon name="user" [size]="20"></app-icon>
          <div class="sale-type-info">
            <span class="sale-type-name">Con Cliente</span>
            <span class="sale-type-desc">{{ cartState?.customer ? customerDisplayName : 'Seleccionar cliente' }}</span>
          </div>
        </button>
      </div>

      <!-- Selected Customer Display -->
      <div *ngIf="!paymentState.isAnonymousSale && cartState?.customer" class="selected-customer">
        <div class="customer-avatar">
          <app-icon name="user-check" [size]="16"></app-icon>
        </div>
        <div class="customer-info">
          <span class="customer-name">{{ customerDisplayName }}</span>
          <span class="customer-email">{{ customerEmail }}</span>
        </div>
        <button type="button" class="change-customer-btn" (click)="openCustomerSelector()">
          <app-icon name="edit-2" [size]="14"></app-icon>
        </button>
      </div>

      <!-- Select Customer Button -->
      <button
        *ngIf="!paymentState.isAnonymousSale && !cartState?.customer && !showCustomerSelector"
        type="button"
        class="select-customer-btn"
        (click)="openCustomerSelector()"
      >
        <app-icon name="user-plus" [size]="18"></app-icon>
        <span>Seleccionar Cliente</span>
      </button>

      <!-- Customer Selector Panel -->
      <div *ngIf="showCustomerSelector" class="customer-selector">
        <div class="selector-header">
          <span>Buscar Cliente</span>
          <button type="button" (click)="closeCustomerSelector()">
            <app-icon name="x" [size]="16"></app-icon>
          </button>
        </div>

        <app-input
          [placeholder]="'Buscar por nombre, email o documento...'"
          [size]="'sm'"
          (inputChange)="onCustomerSearch($event)"
        ></app-input>

        <!-- Search Results -->
        <div *ngIf="!showCreateCustomerForm && customerSearchResults.length > 0" class="search-results">
          <button
            *ngFor="let customer of customerSearchResults"
            type="button"
            class="customer-result"
            (click)="selectCustomer(customer)"
          >
            <span class="result-name">{{ customer.first_name }} {{ customer.last_name }}</span>
            <span class="result-email">{{ customer.email }}</span>
          </button>
        </div>

        <!-- Create Customer Button - Always visible when not in create mode -->
        <div *ngIf="!showCreateCustomerForm" class="create-customer-action">
          <button type="button" class="create-customer-btn" (click)="switchToCreateCustomer()">
            <app-icon name="user-plus" [size]="16"></app-icon>
            <span>Crear nuevo cliente</span>
          </button>
        </div>

        <!-- Create Customer Form -->
        <div *ngIf="showCreateCustomerForm" class="create-customer-form">
          <h5>Nuevo Cliente</h5>
          <app-input [formControl]="customerEmailControl" [label]="'Email'" [placeholder]="'correo@ejemplo.com'" [size]="'sm'"></app-input>
          <div class="form-row">
            <app-input [formControl]="customerFirstNameControl" [label]="'Nombre'" [placeholder]="'Juan'" [size]="'sm'"></app-input>
            <app-input [formControl]="customerLastNameControl" [label]="'Apellido'" [placeholder]="'Pérez'" [size]="'sm'"></app-input>
          </div>
          <app-input [formControl]="customerPhoneControl" [label]="'Teléfono'" [placeholder]="'+1 234 5678'" [size]="'sm'"></app-input>
          <div class="form-row">
            <app-selector [formControl]="customerDocumentTypeControl" [label]="'Tipo Doc.'" [placeholder]="'Seleccionar'" [size]="'sm'" [options]="documentTypeOptions"></app-selector>
            <app-input [formControl]="customerDocumentNumberControl" [label]="'Número Doc.'" [placeholder]="'12345678'" [size]="'sm'"></app-input>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-create" (click)="onCreateCustomer()">Crear</button>
            <button type="button" class="btn-cancel" (click)="switchToCustomerSearch()">Cancelar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Footer Buttons -->
  <div slot="footer" class="payment-footer">
    <div class="footer-row">
      <button type="button" class="btn-cancel-payment" (click)="onModalClosed()" [disabled]="paymentState.isProcessing">
        Cancelar
      </button>
      <button type="button" class="btn-draft" (click)="saveAsDraft()" [disabled]="paymentState.isProcessing">
        <app-icon name="save" [size]="16"></app-icon>
        Borrador
      </button>
    </div>
    <button
      type="button"
      class="btn-confirm"
      (click)="processPayment()"
      [disabled]="!canProcessPayment() || paymentState.isProcessing"
      [class.loading]="paymentState.isProcessing"
    >
      <app-icon *ngIf="!paymentState.isProcessing" name="check-circle" [size]="20"></app-icon>
      <span *ngIf="paymentState.isProcessing" class="spinner"></span>
      {{ paymentState.selectedMethod?.type === "cash" ? "Cobrar" : "Confirmar Pago" }}
    </button>
  </div>
</app-modal>

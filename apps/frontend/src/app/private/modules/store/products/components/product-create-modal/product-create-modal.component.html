<app-modal
  [isOpen]="isOpen"
  (isOpenChange)="isOpenChange.emit($event)"
  (cancel)="onCancel()"
  [size]="'md'"
  [title]="isEditMode ? 'Editar Producto' : 'Nuevo Producto'"
  subtitle="Configura los productos esenciales"
>

  <div class="p-2 md:p-4">
    <form [formGroup]="productForm" class="space-y-2 md:space-y-2 md:space-y-4">

      <!-- Name -->
      <div>
        <app-input label="Nombre del Producto" formControlName="name" placeholder="Ej. Camiseta Algodón Premium"
          [error]="getErrorMessage('name')" [required]="true"></app-input>
      </div>

      <!-- Price, Stock & SKU Row -->
      <div class="grid grid-cols-3 gap-2 md:gap-4">
        <app-input label="Precio Base" type="number" formControlName="base_price" [error]="getErrorMessage('base_price')"
          prefix="$" [required]="true" placeholder="0.00"></app-input>

        <!-- Stock Field: Different behavior for create vs edit mode -->
        <div *ngIf="!isEditMode">
          <app-input label="Cantidad/Stock" type="number" formControlName="stock_quantity"
            [error]="getErrorMessage('stock_quantity')" placeholder="0"
            tooltipText="Stock inicial del producto" [required]="true"></app-input>
        </div>

        <div *ngIf="isEditMode" class="relative">
          <div (click)="onStockAdjustmentClick()" class="cursor-pointer group" title="Click para ajustar stock">
            <app-input label="Stock" type="number" formControlName="stock_quantity"
              [disabled]="true" placeholder="Click para ajustar stock" class="opacity-75 cursor-pointer"
              [suffixIcon]="true">
              <ng-container slot="suffix-icon">
                <svg class="h-5 w-5 text-gray-400 group-hover:text-primary-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
              </ng-container>
            </app-input>
          </div>
        </div>

        <div>
          <app-input label="SKU" formControlName="sku" placeholder="Ej. CAM-001"
            [error]="getErrorMessage('sku')"></app-input>
          <small class="text-xs text-gray-400 mt-0.5 block">Opcional</small>
        </div>
      </div>

      <!-- Category & Brand Row -->
      <div class="grid grid-cols-2 gap-2 md:gap-4">
        <div>
          <div class="flex gap-2 items-end">
            <app-selector class="flex-1" label="Categoría" [options]="categoryOptions" formControlName="category_id"
              placeholder="Seleccionar"></app-selector>
            <button type="button" (click)="isCategoryCreateOpen = true"
              class="p-2 text-gray-500 hover:bg-gray-100 border border-gray-300 bg-white mb-0.5"
              style="border-radius: var(--radius-sm);">
              <app-icon name="plus" size="20"></app-icon>
            </button>
          </div>
          <small class="text-xs text-gray-400 mt-0.5 block">Opcional</small>
        </div>

        <div>
          <div class="flex gap-2 items-end">
            <app-selector class="flex-1" label="Marca" [options]="brandOptions"
              formControlName="brand_id" placeholder="Seleccionar"></app-selector>
            <button type="button" (click)="isBrandCreateOpen = true"
              class="p-2 text-gray-500 hover:bg-gray-100 border border-gray-300 bg-white mb-0.5"
              style="border-radius: var(--radius-sm);">
              <app-icon name="plus" size="20"></app-icon>
            </button>
          </div>
          <small class="text-xs text-gray-400 mt-0.5 block">Opcional</small>
        </div>
      </div>

      <!-- Advanced Link -->
      <div class="pt-2">
        <button type="button" (click)="goToAdvancedCreation()"
          class="text-sm text-primary-600 hover:text-primary-700 font-medium flex items-center gap-1 transition-colors">
          <app-icon name="settings" size="14"></app-icon>
          Configuración avanzada (variantes, imágenes, descripción)
        </button>
      </div>

    </form>
  </div>

  <!-- Footer -->
  <div slot="footer" class="max-w-full">
    <div class="flex items-center justify-end gap-2 md:gap-3 p-2 md:px-4 md:py-3 bg-gray-50 rounded-b-xl">
      <app-button variant="outline" (clicked)="onCancel()" [disabled]="isSubmitting"
        customClasses="!rounded-xl flex-1 sm:flex-none font-bold">
        Cancelar
      </app-button>

      <app-button variant="primary" (clicked)="onSubmit()" [loading]="isSubmitting" [disabled]="isSubmitting"
        customClasses="!rounded-xl flex-1 sm:flex-none font-bold shadow-md shadow-primary-200 active:scale-95 transition-all">
        {{ isEditMode ? 'Guardar Cambios' : 'Crear Producto' }}
      </app-button>
    </div>
  </div>
</app-modal>

<!-- Quick Create Modals -->
<app-category-quick-create [isOpen]="isCategoryCreateOpen" (isOpenChange)="isCategoryCreateOpen = $event"
  (created)="onCategoryCreated($event)" (cancel)="isCategoryCreateOpen = false"></app-category-quick-create>

<app-brand-quick-create
  [isOpen]="isBrandCreateOpen"
  (isOpenChange)="isBrandCreateOpen = $event"
  (created)="onBrandCreated($event)"
  (cancel)="isBrandCreateOpen = false"
></app-brand-quick-create>

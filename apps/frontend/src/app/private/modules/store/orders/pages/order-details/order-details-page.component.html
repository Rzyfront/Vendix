<div class="min-h-screen" style="background-color: var(--color-background)">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex justify-center items-center h-64">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
    </div>
  }

  <!-- Error State -->
  @if (error) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <div class="flex">
        <div class="text-red-500 mr-3">
          <app-icon name="alert-triangle" size="24" class="text-red-500"></app-icon>
        </div>
        <div>
          <h3 class="text-red-800 font-medium">Error</h3>
          <p class="text-red-600">{{ error }}</p>
          <app-button
            variant="outline"
            (clicked)="loadData()"
            customClasses="mt-2 !text-red-700 !border-red-300 hover:!bg-red-50"
          >
            Intentar de nuevo
          </app-button>
        </div>
      </div>
    </div>
  }

  <!-- Content when loaded -->
  @if (order(); as orderData) {
    <!-- Sticky Header Component -->
    <app-sticky-header
      [title]="headerTitle()"
      [subtitle]="headerSubtitle()"
      icon="shopping-cart"
      [showBackButton]="true"
      backRoute="/admin/orders"
      [badgeText]="headerBadgeText()"
      [badgeColor]="headerBadgeColor()"
      [actions]="headerActions()"
      (actionClicked)="onHeaderAction($event)"
    ></app-sticky-header>

    <!-- Main Grid: Two columns -->
    <div class="max-w-[1600px] mx-auto p-2 md:p-4">

      <!-- Channel + Delivery Badges Row -->
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <!-- Channel badge -->
        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-bold border"
          [ngClass]="{
            'bg-blue-50 text-blue-700 border-blue-200': channelConfig().color === 'blue',
            'bg-green-50 text-green-700 border-green-200': channelConfig().color === 'green',
            'bg-emerald-50 text-emerald-700 border-emerald-200': channelConfig().color === 'emerald',
            'bg-purple-50 text-purple-700 border-purple-200': channelConfig().color === 'purple',
            'bg-orange-50 text-orange-700 border-orange-200': channelConfig().color === 'orange'
          }"
        >
          <app-icon [name]="channelConfig().icon" size="14"></app-icon>
          {{ channelConfig().label }}
        </span>

        <!-- Delivery type badge -->
        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-xs font-bold bg-gray-50 text-gray-700 border border-gray-200">
          <app-icon [name]="deliveryConfig().icon" size="14"></app-icon>
          {{ deliveryConfig().label }}
        </span>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-2 lg:gap-5">
        <!-- ═══ COLUMNA IZQUIERDA ═══ -->
        <div class="flex flex-col gap-2">
          <!-- 1. INFORMACION DEL CLIENTE -->
          <app-card title="Informacion del Cliente" shadow="sm" [responsivePadding]="true">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4">
              <!-- Profile Info -->
              <div class="md:col-span-2 flex items-start gap-4">
                <div class="w-14 h-14 bg-primary/10 text-primary rounded-xl flex items-center justify-center text-xl font-bold border border-primary/5">
                  {{ orderData.users?.first_name?.charAt(0) || "C" }}
                </div>
                <div class="space-y-1">
                  <p class="text-lg font-bold text-gray-900">
                    @if (orderData.users?.first_name || orderData.users?.last_name) {
                      {{ orderData.users?.first_name }} {{ orderData.users?.last_name }}
                    } @else {
                      Consumidor Final
                    }
                  </p>
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <app-icon name="mail" size="16" class="text-gray-400"></app-icon>
                    {{ orderData.users?.email || 'Sin correo registrado' }}
                  </div>
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <app-icon name="phone" size="16" class="text-gray-400"></app-icon>
                    {{ orderData.users?.phone || 'Sin telefono registrado' }}
                  </div>
                </div>
              </div>

              <!-- Direccion de Entrega -->
              <div class="bg-[var(--color-surface)] rounded-xl border border-border p-4">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider mb-3 flex items-center gap-2">
                  <app-icon name="truck" size="14" class="text-primary-600"></app-icon>
                  Direccion de Entrega
                </h3>
                @if (orderData.addresses_orders_shipping_address_idToaddresses; as addr) {
                  <div class="text-gray-700 space-y-1">
                    <p class="font-semibold">{{ addr.address_line1 }}</p>
                    @if (addr.address_line2) {
                      <p class="text-sm">{{ addr.address_line2 }}</p>
                    }
                    <p class="text-sm text-gray-500">
                      {{ addr.city }}, {{ addr.state_province }} {{ addr.postal_code }}
                    </p>
                    <p class="text-xs font-bold text-gray-400 mt-2 uppercase">{{ addr.country_code }}</p>
                  </div>
                } @else {
                  <p class="text-sm text-gray-400 italic">No especificada</p>
                }
              </div>

              <!-- Direccion de Facturacion -->
              <div class="bg-[var(--color-surface)] rounded-xl border border-border p-4">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider mb-3 flex items-center gap-2">
                  <app-icon name="file-text" size="14" class="text-primary-600"></app-icon>
                  Direccion de Facturacion
                </h3>
                @if (orderData.addresses_orders_billing_address_idToaddresses; as addr) {
                  <div class="text-gray-700 space-y-1">
                    <p class="font-semibold">{{ addr.address_line1 }}</p>
                    @if (addr.address_line2) {
                      <p class="text-sm">{{ addr.address_line2 }}</p>
                    }
                    <p class="text-sm text-gray-500">
                      {{ addr.city }}, {{ addr.state_province }} {{ addr.postal_code }}
                    </p>
                    <p class="text-xs font-bold text-gray-400 mt-2 uppercase">{{ addr.country_code }}</p>
                  </div>
                } @else {
                  <p class="text-sm text-gray-400 italic">Igual a la direccion de envio</p>
                }
              </div>
            </div>
          </app-card>

          <!-- 2. ARTICULOS DEL PEDIDO -->
          <app-card shadow="sm" [responsivePadding]="true">
            <div slot="header" class="flex items-center justify-between w-full">
              <h3 class="text-lg font-semibold text-[var(--color-text-primary)]">Articulos del Pedido</h3>
              <span class="text-xs font-medium text-gray-500 bg-[var(--color-surface)] px-3 py-1 rounded-lg">
                {{ orderData.order_items?.length || 0 }} productos
              </span>
            </div>

            <div class="space-y-2">
              @for (item of orderData.order_items; track item.id) {
                <div class="p-4 bg-[var(--color-surface)] rounded-xl border border-border hover:border-gray-300 transition-colors">
                  <div class="flex items-start gap-4">
                    <!-- Product Image -->
                    <div class="w-16 h-16 bg-white rounded-lg flex-shrink-0 flex items-center justify-center border border-border overflow-hidden">
                      @if (item.products && item.products.image_url) {
                        <img [src]="item.products.image_url" class="w-full h-full object-cover" />
                      } @else {
                        <app-icon name="image" size="24" class="text-gray-300"></app-icon>
                      }
                    </div>

                    <!-- Product Info -->
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-gray-900 truncate">{{ item.product_name }}</h3>
                      <p class="text-xs font-mono text-gray-500 mt-1">SKU: {{ item.variant_sku || "N/A" }}</p>
                      @if (item.variant_attributes) {
                        <div class="mt-2 text-xs text-gray-500">{{ item.variant_attributes }}</div>
                      }
                    </div>

                    <!-- Price -->
                    <div class="text-right">
                      <p class="font-bold text-gray-900 text-lg">{{ item.total_price || 0 | currency }}</p>
                      <p class="text-sm text-gray-500">{{ item.quantity }} x {{ item.unit_price || 0 | currency }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>
          </app-card>

          <!-- 3. HISTORIAL DE LA ORDEN (cronológico ascendente) -->
          <app-card title="Historial de la Orden" shadow="sm" [responsivePadding]="true">
            <div class="space-y-0">
              @for (log of sortedTimeline(); track $index; let last = $last) {
                <div class="timeline-item">
                  <div class="timeline-marker" [ngClass]="{ 'bg-primary': last }"></div>
                  <div class="flex flex-col sm:flex-row sm:justify-between gap-2">
                    <div>
                      <p class="text-sm font-bold text-gray-900">{{ getTimelineLabel(log) }}</p>
                      <p class="text-xs text-gray-500 mt-1">
                        Realizado por
                        <span class="font-semibold text-gray-700">{{ log.users?.first_name }} {{ log.users?.last_name }}</span>
                      </p>
                      @if (log.new_values?.state) {
                        <div class="mt-2 text-xs bg-[var(--color-surface)] text-text-secondary px-3 py-1.5 rounded-lg inline-flex items-center gap-2 border border-border">
                          <span class="w-1.5 h-1.5 rounded-full bg-primary-500"></span>
                          Nuevo estado: {{ formatStatus(log.new_values.state) }}
                        </div>
                      }
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">
                      {{ formatDate(log.created_at) }}
                    </span>
                  </div>
                </div>
              }

              @if (sortedTimeline().length === 0) {
                <div class="timeline-item">
                  <div class="timeline-marker bg-primary"></div>
                  <div>
                    <p class="text-sm font-bold text-gray-900">Orden Creada</p>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">
                      {{ formatDate(orderData.created_at) }}
                    </span>
                  </div>
                </div>
              }
            </div>
          </app-card>
        </div>

        <!-- ═══ COLUMNA DERECHA (SIDEBAR) ═══ -->
        <div class="flex flex-col gap-2">

          <!-- SHIPPING METHOD ASSIGNMENT (only for delivery_type 'other') -->
          @if (showShippingAssignment()) {
            <div class="bg-amber-50 rounded-xl border border-amber-200 p-4 shadow-sm">
              <h3 class="text-xs font-bold text-amber-800 uppercase tracking-wider mb-2 flex items-center gap-2">
                <app-icon name="truck" size="14" class="text-amber-600"></app-icon>
                Asignar Metodo de Envio
              </h3>

              @if (!showShippingMethodCard()) {
                <p class="text-xs text-amber-700 mb-3">
                  Esta orden no tiene un metodo de envio asignado. Puedes asignar uno para definir el tipo de entrega.
                </p>
                <app-button variant="primary" [fullWidth]="true" (clicked)="openShippingAssignCard()" customClasses="!bg-amber-600 hover:!bg-amber-700">
                  <app-icon slot="icon" name="package" size="16"></app-icon>
                  Seleccionar
                </app-button>
              } @else {
                <!-- Expanded: method list -->
                @if (isLoadingShippingMethods()) {
                  <div class="flex justify-center py-4">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-amber-600"></div>
                  </div>
                } @else if (shippingMethods().length === 0) {
                  <p class="text-xs text-amber-600 italic py-2">No hay metodos de envio activos configurados.</p>
                } @else {
                  <div class="space-y-1.5 mb-3 max-h-48 overflow-y-auto">
                    @for (method of shippingMethods(); track method.id) {
                      <button
                        (click)="onShippingMethodSelect(method.id)"
                        class="w-full text-left p-2.5 rounded-lg border transition-all text-sm flex items-center gap-2.5"
                        [ngClass]="{
                          'border-amber-400 bg-amber-100 ring-1 ring-amber-400': selectedShippingMethodId() === method.id,
                          'border-amber-200 bg-white hover:bg-amber-50': selectedShippingMethodId() !== method.id
                        }"
                      >
                        <app-icon [name]="shippingMethodsService.getShippingMethodIcon(method.type)" size="16" class="text-amber-700 flex-shrink-0"></app-icon>
                        <div class="min-w-0 flex-1">
                          <p class="font-semibold text-gray-900 truncate text-xs">{{ method.name }}</p>
                          <p class="text-[10px] text-gray-500">{{ shippingMethodsService.getShippingMethodTypeLabel(method.type) }}</p>
                        </div>
                      </button>
                    }
                  </div>
                }

                <!-- Shipping cost field (shown when a method is selected) -->
                @if (selectedShippingMethod()) {
                  <div class="mb-3" [formGroup]="shippingAssignForm">
                    <label class="block text-xs font-bold text-amber-800 mb-1">Costo de envio</label>
                    <input
                      type="number"
                      formControlName="shipping_cost"
                      min="0"
                      step="0.01"
                      class="w-full px-3 py-2 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-400 focus:border-amber-400 bg-white"
                      placeholder="0.00"
                    />
                  </div>
                }

                <!-- Action buttons -->
                <div class="flex items-center gap-2">
                  <app-button variant="outline" size="sm" [fullWidth]="true" (clicked)="skipShippingAssignment()">
                    Continuar sin metodo
                  </app-button>
                  @if (selectedShippingMethodId()) {
                    <app-button variant="primary" size="sm" [fullWidth]="true" (clicked)="submitShippingAssignment()" [disabled]="isProcessingAction()" customClasses="!bg-amber-600 hover:!bg-amber-700">
                      {{ isProcessingAction() ? 'Asignando...' : 'Confirmar' }}
                    </app-button>
                  }
                </div>
              }
            </div>
          }

          <!-- 4. PROGRESO DE LA ORDEN -->
          <app-card shadow="sm" [responsivePadding]="true">
            <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">
              Progreso de la Orden
            </h2>

            <div class="space-y-0">
              @for (step of lifecycleSteps(); track step.key) {
                <div class="progress-item"
                  [class.line-completed]="step.status === 'completed'">
                  <div class="progress-marker"
                    [ngClass]="{
                      'completed': step.status === 'completed',
                      'current': step.status === 'current',
                      'upcoming': step.status === 'upcoming',
                      'terminal-cancelled': step.status === 'terminal' && step.key === 'cancelled',
                      'terminal-refunded': step.status === 'terminal' && step.key === 'refunded'
                    }"
                  ></div>
                  <span class="text-sm font-semibold"
                    [ngClass]="{
                      'text-green-600': step.status === 'completed',
                      'text-green-800': step.status === 'current',
                      'text-gray-400': step.status === 'upcoming',
                      'text-red-600': step.status === 'terminal' && step.key === 'cancelled',
                      'text-orange-600': step.status === 'terminal' && step.key === 'refunded'
                    }"
                  >
                    {{ step.label }}
                  </span>
                </div>
              }
            </div>
          </app-card>

          <!-- 5. FLOW METADATA CARDS -->

          <!-- Shipping Info Card -->
          @if (flowMetadata().tracking_number || flowMetadata().carrier || flowMetadata().shipping_notes) {
            <div class="bg-blue-50 rounded-xl border border-blue-200 p-4 shadow-sm">
              <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                <app-icon name="truck" size="14" class="text-blue-600"></app-icon>
                Informacion de Envio
              </h3>
              <div class="space-y-2 text-sm">
                @if (flowMetadata().tracking_number) {
                  <div class="flex items-center gap-2">
                    <span class="text-blue-600 font-medium">Rastreo:</span>
                    <span class="text-blue-900 font-mono">{{ flowMetadata().tracking_number }}</span>
                  </div>
                }
                @if (flowMetadata().carrier) {
                  <div class="flex items-center gap-2">
                    <span class="text-blue-600 font-medium">Transportista:</span>
                    <span class="text-blue-900">{{ flowMetadata().carrier }}</span>
                  </div>
                }
                @if (flowMetadata().shipping_notes) {
                  <div class="text-blue-700 text-xs mt-2">{{ flowMetadata().shipping_notes }}</div>
                }
              </div>
            </div>
          }

          <!-- Delivery Info Card -->
          @if (flowMetadata().delivered_to || flowMetadata().delivery_notes) {
            <div class="bg-green-50 rounded-xl border border-green-200 p-4 shadow-sm">
              <h3 class="text-xs font-bold text-green-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                <app-icon name="package" size="14" class="text-green-600"></app-icon>
                Informacion de Entrega
              </h3>
              <div class="space-y-2 text-sm">
                @if (flowMetadata().delivered_to) {
                  <div class="flex items-center gap-2">
                    <span class="text-green-600 font-medium">Recibido por:</span>
                    <span class="text-green-900">{{ flowMetadata().delivered_to }}</span>
                  </div>
                }
                @if (flowMetadata().delivery_notes) {
                  <div class="text-green-700 text-xs mt-2">{{ flowMetadata().delivery_notes }}</div>
                }
              </div>
            </div>
          }

          <!-- Cancellation Info Card -->
          @if (orderData.state === 'cancelled' && flowMetadata().cancellation_reason) {
            <div class="bg-red-50 rounded-xl border border-red-200 p-4 shadow-sm">
              <h3 class="text-xs font-bold text-red-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                <app-icon name="x-circle" size="14" class="text-red-600"></app-icon>
                Orden Cancelada
              </h3>
              <p class="text-sm text-red-700">{{ flowMetadata().cancellation_reason }}</p>
            </div>
          }

          <!-- Refund Info Card -->
          @if (orderData.state === 'refunded' && (flowMetadata().refund_reason || flowMetadata().refund_amount)) {
            <div class="bg-orange-50 rounded-xl border border-orange-200 p-4 shadow-sm">
              <h3 class="text-xs font-bold text-orange-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                <app-icon name="rotate-ccw" size="14" class="text-orange-600"></app-icon>
                Reembolso Procesado
              </h3>
              <div class="space-y-2 text-sm">
                @if (flowMetadata().refund_amount) {
                  <div class="flex items-center gap-2">
                    <span class="text-orange-600 font-medium">Monto:</span>
                    <span class="text-orange-900 font-bold">{{ flowMetadata().refund_amount | currency }}</span>
                  </div>
                }
                @if (flowMetadata().refund_reason) {
                  <p class="text-orange-700">{{ flowMetadata().refund_reason }}</p>
                }
              </div>
            </div>
          }

          <!-- 6. SEGUIMIENTO DE ENVIO -->
          @if (showShipmentTracking()) {
            <app-card shadow="sm" [responsivePadding]="true">
              <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 flex items-center gap-2">
                <app-icon name="map-pin" size="16" class="text-primary-600"></app-icon>
                Seguimiento de Envio
              </h2>

              <!-- Tracking Timeline -->
              <div class="tracking-timeline">
                @for (step of trackingSteps(); track step.key; let last = $last) {
                  <div class="tracking-step">
                    <div class="tracking-indicator">
                      <div class="tracking-dot"
                        [ngClass]="{
                          'bg-green-500 border-green-500': step.status === 'completed',
                          'bg-primary-500 border-primary-500 shadow-sm': step.status === 'current',
                          'bg-gray-200 border-gray-300': step.status === 'pending'
                        }"
                      ></div>
                      @if (!last) {
                        <div class="tracking-line"
                          [ngClass]="{
                            'bg-green-400': step.status === 'completed',
                            'bg-gray-200': step.status !== 'completed'
                          }"
                        ></div>
                      }
                    </div>
                    <span class="text-xs font-semibold"
                      [ngClass]="{
                        'text-green-700': step.status === 'completed',
                        'text-primary-600': step.status === 'current',
                        'text-gray-400': step.status === 'pending'
                      }"
                    >
                      {{ step.label }}
                    </span>
                  </div>
                }
              </div>

              <!-- Tracking number -->
              @if (flowMetadata().tracking_number) {
                <div class="mt-4 p-3 bg-[var(--color-surface)] rounded-lg border border-border flex items-center justify-between gap-2">
                  <div class="min-w-0">
                    <span class="text-[10px] font-bold text-text-secondary uppercase block">Numero de rastreo</span>
                    <code class="text-sm font-mono text-gray-900 truncate block">{{ flowMetadata().tracking_number }}</code>
                  </div>
                  <button
                    (click)="copyTrackingNumber()"
                    class="flex-shrink-0 p-2 rounded-lg hover:bg-gray-100 transition-colors text-gray-500 hover:text-gray-700"
                  >
                    <app-icon name="copy" size="16"></app-icon>
                  </button>
                </div>
              }
            </app-card>
          }

          <!-- 7. ACCIONES DE FLUJO -->
          <app-card shadow="sm" [responsivePadding]="true">
            <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">Acciones</h2>

            @if (availableActions().length > 0) {
              <div class="space-y-2">
                @for (action of availableActions(); track action.id) {
                  @if (action.type === 'alert') {
                    <app-alert-banner [variant]="$any(action.color)" [icon]="action.icon">
                      {{ action.label }}
                    </app-alert-banner>
                  } @else {
                    <app-button
                      [variant]="action.variant === 'danger' ? 'outline-danger' : action.variant === 'warning' ? 'outline-warning' : action.variant === 'success' ? 'success' : 'primary'"
                      [fullWidth]="true"
                      [disabled]="isProcessingAction()"
                      (clicked)="executeAction(action.id)"
                    >
                      <app-icon slot="icon" [name]="action.icon" size="16"></app-icon>
                      {{ action.label }}
                    </app-button>
                  }
                }
              </div>
            } @else {
              <div class="text-[10px] text-center text-text-secondary font-bold uppercase tracking-widest bg-[var(--color-surface)] py-3 rounded-xl border border-dashed border-border">
                No hay acciones disponibles
              </div>
            }
          </app-card>

          <!-- 8. RESUMEN DE PAGO -->
          <app-card shadow="sm" [responsivePadding]="true">
            <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4">Resumen de Pago</h2>

            <div class="space-y-3">
              <div class="flex justify-between items-center text-sm">
                <span class="text-text-secondary">Subtotal</span>
                <span class="font-semibold text-gray-900">{{ orderData.subtotal_amount || 0 | currency }}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-text-secondary">Descuento</span>
                <span class="font-semibold text-green-600">-{{ orderData.discount_amount || 0 | currency }}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-text-secondary">Envio</span>
                <span class="font-semibold text-gray-900">{{ orderData.shipping_cost || 0 | currency }}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-text-secondary">Impuestos</span>
                <span class="font-semibold text-gray-900">{{ orderData.tax_amount || 0 | currency }}</span>
              </div>
              <div class="pt-3 border-t border-border flex justify-between items-center">
                <span class="text-base font-bold text-gray-900">Total</span>
                <span class="text-2xl font-black text-primary-600 font-mono tracking-tighter">
                  {{ orderData.grand_total || 0 | currency }}
                </span>
              </div>
            </div>

            <!-- Payment History -->
            @if (orderData.payments && orderData.payments.length > 0) {
              <div class="mt-4 space-y-2">
                <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider">Historial de Pagos</h3>
                @for (payment of orderData.payments; track payment.id) {
                  <div class="p-3 bg-[var(--color-surface)] rounded-lg border border-border">
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-medium">{{ payment.amount | currency }}</span>
                      <span class="px-2 py-0.5 text-[10px] font-black uppercase rounded-md"
                        [ngClass]="getPaymentStateClass(payment.state)">
                        {{ getPaymentStateLabel(payment.state) }}
                      </span>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">{{ formatDate(payment.created_at) }}</p>
                  </div>
                }
              </div>
            } @else {
              <div class="mt-4 p-3 bg-[var(--color-surface)] rounded-lg border border-border flex items-center justify-between">
                <span class="text-xs font-bold text-text-secondary uppercase">Estado del Pago</span>
                <span class="px-3 py-1 text-[10px] font-black uppercase rounded-lg tracking-wider bg-gray-500/20 text-gray-400">
                  Pendiente
                </span>
              </div>
            }

            <!-- Invoice Download -->
            <div class="pt-4">
              @if (orderData.state === 'finished' || orderData.state === 'delivered') {
                <app-button variant="secondary" [fullWidth]="true" customClasses="!bg-gray-900 hover:!bg-black !shadow-md">
                  <app-icon slot="icon" name="file-text" size="16"></app-icon>
                  Descargar Factura
                </app-button>
              } @else {
                <div class="text-[10px] text-center text-text-secondary font-bold uppercase tracking-widest bg-[var(--color-surface)] py-3 rounded-xl border border-dashed border-border">
                  Factura no disponible
                </div>
              }
            </div>
          </app-card>
        </div>
      </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         FLOW MODALS
         ═══════════════════════════════════════════════════════════ -->

    <!-- PAY MODAL (new rich component) -->
    <app-order-payment-modal
      [isOpen]="showPayModal()"
      [order]="orderData"
      [paymentMethods]="paymentMethods()"
      (isOpenChange)="showPayModal.set($event)"
      (closed)="showPayModal.set(false)"
      (paymentSubmitted)="onPaymentSubmitted($event)"
    />

    <!-- SHIP MODAL (delivery-type aware) -->
    <app-modal
      [isOpen]="showShipModal()"
      (closed)="showShipModal.set(false); isManualShipMode.set(false)"
      [title]="isManualShipMode() ? 'Despachar sin confirmar pago' : shipModalConfig().title"
      size="md"
    >
      <div class="p-4 space-y-4" [formGroup]="shipForm">
        @if (isManualShipMode()) {
          <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-start gap-3">
            <app-icon name="alert-triangle" size="18" class="text-orange-600 mt-0.5"></app-icon>
            <div>
              <p class="text-sm font-bold text-orange-800">Despacho sin pago confirmado</p>
              <p class="text-xs text-orange-600 mt-0.5">La orden se despachara sin que el pago haya sido confirmado. Deberas confirmar el pago antes de marcar la entrega.</p>
            </div>
          </div>
        }
        @if (shipModalConfig().showShippingInfo) {
          <div class="bg-gray-50 rounded-lg p-4 space-y-3">
            <h4 class="text-sm font-bold text-gray-700">Información de Envío</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
              @if (orderData.shipping_method; as method) {
                <div>
                  <span class="text-gray-500">Método</span>
                  <p class="font-medium text-gray-900">{{ method.name }}</p>
                </div>
              }
              @if (orderData.shipping_rate?.shipping_zone; as zone) {
                <div>
                  <span class="text-gray-500">Zona</span>
                  <p class="font-medium text-gray-900">{{ zone.display_name || zone.name }}</p>
                </div>
              }
              <div>
                <span class="text-gray-500">Costo de envío</span>
                <p class="font-medium text-gray-900">{{ orderData.shipping_cost || 0 | currency }}</p>
              </div>
              @if (orderData.shipping_method; as sm) {
                @if (sm.min_days || sm.max_days) {
                  <div>
                    <span class="text-gray-500">Tiempo estimado</span>
                    <p class="font-medium text-gray-900">
                      @if (sm.min_days && sm.max_days) {
                        {{ sm.min_days }}–{{ sm.max_days }} días
                      } @else if (sm.max_days) {
                        Hasta {{ sm.max_days }} días
                      } @else {
                        {{ sm.min_days }}+ días
                      }
                    </p>
                  </div>
                }
              }
            </div>
          </div>
        }
        @if (shipModalConfig().showTracking) {
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1.5">Numero de Rastreo</label>
            <input
              type="text"
              formControlName="tracking_number"
              placeholder="Ej: 1Z999AA10123456784"
              class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
          </div>
        }
        @if (shipModalConfig().showCarrier) {
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1.5">Transportista</label>
            <input
              type="text"
              formControlName="carrier"
              placeholder="Ej: Servientrega, Coordinadora"
              class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
          </div>
        }
        @if (shipModalConfig().showNotes) {
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1.5">Notas</label>
            <textarea
              formControlName="notes"
              rows="2"
              placeholder="Notas adicionales..."
              class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
            ></textarea>
          </div>
        }
      </div>

      <div slot="footer" class="flex items-center justify-end gap-2 p-4 border-t border-border">
        <app-button variant="outline" (clicked)="showShipModal.set(false); isManualShipMode.set(false)">Cancelar</app-button>
        <app-button
          [variant]="isManualShipMode() ? 'outline-warning' : 'primary'"
          (clicked)="submitShipment()"
          [disabled]="isProcessingAction()"
        >
          {{ isProcessingAction() ? 'Procesando...' : (isManualShipMode() ? 'Despachar sin pago' : shipModalConfig().confirmLabel) }}
        </app-button>
      </div>
    </app-modal>

    <!-- DELIVER MODAL -->
    <app-modal
      [isOpen]="showDeliverModal()"
      (closed)="showDeliverModal.set(false); isManualDeliverMode.set(false)"
      [title]="isManualDeliverMode() ? (orderData.delivery_type === 'pickup' ? 'Entregar directamente al cliente' : 'Entregar sin confirmar pago') : 'Marcar como Entregado'"
      size="md"
    >
      <div class="p-4 space-y-4" [formGroup]="deliverForm">
        @if (isManualDeliverMode()) {
          <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-start gap-3">
            <app-icon name="alert-triangle" size="18" class="text-orange-600 mt-0.5"></app-icon>
            <div>
              @if (orderData.delivery_type === 'pickup') {
                <p class="text-sm font-bold text-orange-800">Entrega directa al cliente</p>
                <p class="text-xs text-orange-600 mt-0.5">Se omitira el paso "Lista para recoger" y la orden se marcara como entregada directamente. Si el pago esta confirmado, la orden se finalizara automaticamente.</p>
              } @else {
                <p class="text-sm font-bold text-orange-800">Entrega sin pago confirmado</p>
                <p class="text-xs text-orange-600 mt-0.5">La orden se marcara como entregada sin que el pago haya sido confirmado.</p>
              }
            </div>
          </div>
        }
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1.5">Recibido por</label>
          <input
            type="text"
            formControlName="delivered_to"
            placeholder="Nombre de quien recibio el paquete"
            class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1.5">Notas de Entrega</label>
          <textarea
            formControlName="delivery_notes"
            rows="2"
            placeholder="Notas sobre la entrega..."
            class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
          ></textarea>
        </div>
      </div>

      <div slot="footer" class="flex items-center justify-end gap-2 p-4 border-t border-border">
        <app-button variant="outline" (clicked)="showDeliverModal.set(false); isManualDeliverMode.set(false)">Cancelar</app-button>
        <app-button
          [variant]="isManualDeliverMode() ? 'outline-warning' : 'primary'"
          (clicked)="submitDelivery()"
          [disabled]="isProcessingAction()"
        >
          {{ isProcessingAction() ? 'Procesando...' : (isManualDeliverMode() ? 'Confirmar Entrega Directa' : 'Confirmar Entrega') }}
        </app-button>
      </div>
    </app-modal>

    <!-- CANCEL MODAL -->
    <app-modal
      [isOpen]="showCancelModal()"
      (closed)="showCancelModal.set(false)"
      title="Cancelar Orden"
      size="md"
    >
      <div class="p-4 space-y-4" [formGroup]="cancelForm">
        <div class="bg-red-50 border border-red-200 rounded-xl p-3 flex items-start gap-3">
          <app-icon name="alert-triangle" size="18" class="text-red-600 mt-0.5"></app-icon>
          <div>
            <p class="text-sm font-bold text-red-800">Esta accion no se puede deshacer</p>
            <p class="text-xs text-red-600 mt-0.5">La orden sera cancelada permanentemente.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1.5">Razon de cancelacion *</label>
          <textarea
            formControlName="reason"
            rows="3"
            placeholder="Describe la razon de la cancelacion (minimo 3 caracteres)..."
            class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
          ></textarea>
        </div>
      </div>

      <div slot="footer" class="flex items-center justify-end gap-2 p-4 border-t border-border">
        <app-button variant="outline" (clicked)="showCancelModal.set(false)">Volver</app-button>
        <app-button
          variant="danger"
          (clicked)="submitCancellation()"
          [disabled]="cancelForm.invalid || isProcessingAction()"
        >
          {{ isProcessingAction() ? 'Cancelando...' : 'Cancelar Orden' }}
        </app-button>
      </div>
    </app-modal>

    <!-- REFUND MODAL -->
    <app-modal
      [isOpen]="showRefundModal()"
      (closed)="showRefundModal.set(false)"
      title="Procesar Reembolso"
      size="md"
    >
      <div class="p-4 space-y-4" [formGroup]="refundForm">
        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-start gap-3">
          <app-icon name="alert-triangle" size="18" class="text-orange-600 mt-0.5"></app-icon>
          <div>
            <p class="text-sm font-bold text-orange-800">Reembolso de orden</p>
            <p class="text-xs text-orange-600 mt-0.5">Se procesara el reembolso y la orden pasara a estado reembolsado.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1.5">Monto a Reembolsar</label>
          <input
            type="number"
            formControlName="amount"
            class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
          <p class="text-xs text-gray-500 mt-1">Total de la orden: {{ orderData.grand_total || 0 | currency }}. Dejar vacio para reembolso completo.</p>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1.5">Razon del reembolso *</label>
          <textarea
            formControlName="reason"
            rows="3"
            placeholder="Describe la razon del reembolso (minimo 3 caracteres)..."
            class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
          ></textarea>
        </div>
      </div>

      <div slot="footer" class="flex items-center justify-end gap-2 p-4 border-t border-border">
        <app-button variant="outline" (clicked)="showRefundModal.set(false)">Cancelar</app-button>
        <app-button
          variant="primary"
          (clicked)="submitRefund()"
          [disabled]="refundForm.invalid || isProcessingAction()"
          customClasses="!bg-orange-600 hover:!bg-orange-700"
        >
          {{ isProcessingAction() ? 'Procesando...' : 'Procesar Reembolso' }}
        </app-button>
      </div>
    </app-modal>
  }
</div>

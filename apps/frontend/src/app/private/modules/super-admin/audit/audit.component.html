<div class="space-y-6">
  <!-- Stats Cards -->
  <app-audit-stats [stats]="auditStats"></app-audit-stats>

  <!-- Audit Logs Table Container -->
  <div class="bg-surface rounded-card shadow-card border border-border">
    <div class="px-6 py-4 border-b border-border">
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex-1 min-w-0">
          <h2 class="text-lg font-semibold text-text-primary">
            Logs de Auditoría ({{ pagination.total }})
          </h2>
        </div>

        <div class="filter-compact">
          <!-- Input de búsqueda compacto -->
          <app-inputsearch
            class="w-full sm:w-64"
            size="sm"
            placeholder="Buscar logs..."
            [debounceTime]="1000"
            (searchChange)="onSearchChange($event)"
          ></app-inputsearch>

          <div class="flex gap-2 items-center">
            <app-button
              variant="outline"
              size="sm"
              (clicked)="refreshAuditLogs()"
              [disabled]="isLoading"
              title="Refresh"
            >
              <app-icon name="refresh" [size]="16" slot="icon"></app-icon>
            </app-button>
          </div>
        </div>

        <!-- Filters Dropdown -->
        <div class="relative" [class.show]="showFiltersDropdown">
          <app-button
            variant="primary"
            size="sm"
            (clicked)="toggleFiltersDropdown()"
            [class.active]="hasActiveFilters()"
          >
            <app-icon name="filter" [size]="16" slot="icon"></app-icon>
            <span class="hidden sm:inline">Filtros</span>
            <span
              *ngIf="hasActiveFilters()"
              class="ml-1 px-1.5 py-0.5 text-xs bg-primary text-white rounded-full"
            >
              {{ getActiveFiltersCount() }}
            </span>
          </app-button>

          <!-- Dropdown Menu -->
          <div
            *ngIf="showFiltersDropdown"
            class="absolute right-0 mt-2 w-80 bg-surface border border-border rounded-card shadow-lg z-50 p-4"
          >
            <form [formGroup]="filterForm">
              <!-- Action Filter -->
              <div class="mb-3">
                <label
                  class="block text-xs font-medium text-text-secondary mb-1"
                >
                  Acción
                </label>
                <select
                  formControlName="action"
                  class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option
                    *ngFor="let option of actionOptions"
                    [value]="option.value"
                  >
                    {{ option.label }}
                  </option>
                </select>
              </div>

              <!-- Resource Filter -->
              <div class="mb-3">
                <label
                  class="block text-xs font-medium text-text-secondary mb-1"
                >
                  Recurso
                </label>
                <select
                  formControlName="resource"
                  class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option
                    *ngFor="let option of resourceOptions"
                    [value]="option.value"
                  >
                    {{ option.label }}
                  </option>
                </select>
              </div>

              <!-- Date Range -->
              <div class="grid grid-cols-2 gap-2 mb-3">
                <div>
                  <label
                    class="block text-xs font-medium text-text-secondary mb-1"
                  >
                    Desde
                  </label>
                  <input
                    type="date"
                    formControlName="fromDate"
                    class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>
                <div>
                  <label
                    class="block text-xs font-medium text-text-secondary mb-1"
                  >
                    Hasta
                  </label>
                  <input
                    type="date"
                    formControlName="toDate"
                    class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                  />
                </div>
              </div>

              <!-- Organization ID Filter -->
              <div class="mb-3">
                <label
                  class="block text-xs font-medium text-text-secondary mb-1"
                >
                  ID Organización
                </label>
                <input
                  type="number"
                  formControlName="organizationId"
                  class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                  placeholder="ID Org"
                />
              </div>

              <!-- Store ID Filter -->
              <div class="mb-3">
                <label
                  class="block text-xs font-medium text-text-secondary mb-1"
                >
                  ID Tienda
                </label>
                <input
                  type="number"
                  formControlName="storeId"
                  class="w-full px-2 py-1.5 text-sm border border-border rounded-button bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                  placeholder="ID Tienda"
                />
              </div>

              <!-- Actions -->
              <div class="flex gap-2 pt-2 border-t border-border">
                <app-button
                  variant="outline"
                  size="sm"
                  (clicked)="clearFilters()"
                  class="flex-1"
                >
                  <app-icon name="refresh" [size]="14" slot="icon"></app-icon>
                  Limpiar
                </app-button>
                <app-button
                  variant="primary"
                  size="sm"
                  (clicked)="toggleFiltersDropdown()"
                  class="flex-1"
                >
                  <app-icon name="check" [size]="14" slot="icon"></app-icon>
                  Aplicar
                </app-button>
              </div>
            </form>
          </div>
        </div>

        <!-- Paginación info -->
        <div class="flex items-center gap-2 mt-2 sm:mt-0">
          <span class="text-sm text-text-secondary">
            Página {{ pagination.page }} de {{ pagination.totalPages }}
          </span>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="p-8 text-center">
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"
      ></div>
      <p class="mt-2 text-text-secondary">Cargando logs...</p>
    </div>

    <!-- Empty State -->
    <app-audit-empty-state
      *ngIf="!isLoading && auditLogs.length === 0"
      [title]="getEmptyStateTitle()"
      [description]="getEmptyStateDescription()"
    ></app-audit-empty-state>

    <div *ngIf="auditLogs.length > 0" class="p-6">
      <app-table
        [data]="auditLogs"
        [columns]="tableColumns"
        [actions]="tableActions"
        [loading]="isLoading"
        (sort)="onSortChange($event)"
      >
        <!-- Custom cell for resource -->
        <ng-template #resourceCell let-item>
          <span class="text-sm text-text">
            {{ getResourceDisplay(item.resource) }}
          </span>
        </ng-template>

        <!-- Custom actions -->
        <ng-template #actionsCell let-item>
          <div class="flex items-center gap-2">
            <!-- View Details Button -->
            <button
              (click)="viewLogDetails(item)"
              class="p-1 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
              title="Ver detalles"
            >
              <app-icon name="eye" class="w-4 h-4"></app-icon>
            </button>
          </div>
        </ng-template>
      </app-table>
    </div>

    <!-- Pagination -->
    <div
      *ngIf="!isLoading && auditLogs.length > 0"
      class="flex items-center justify-between p-4 border-t border-border"
    >
      <div class="text-sm text-text-secondary">
        Mostrando {{ auditLogs.length }} de {{ pagination.total }} logs
      </div>
      <div class="flex items-center gap-2">
        <button
          (click)="onPageChange(pagination.page - 1)"
          [disabled]="pagination.page <= 1"
          class="px-3 py-1 text-sm border border-border rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted/20"
        >
          Anterior
        </button>
        <span class="text-sm text-text-secondary">
          Página {{ pagination.page }} de {{ pagination.totalPages }}
        </span>
        <button
          (click)="onPageChange(pagination.page + 1)"
          [disabled]="pagination.page >= pagination.totalPages"
          class="px-3 py-1 text-sm border border-border rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted/20"
        >
          Siguiente
        </button>
      </div>
    </div>
  </div>

  <!-- Audit Details Modal -->
  <app-audit-details-modal
    [isOpen]="isDetailsModalOpen"
    [log]="selectedAuditLog"
    (openChange)="onDetailsModalChange($event)"
  ></app-audit-details-modal>
</div>

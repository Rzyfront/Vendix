<div class="flex flex-col gap-6">
  <!-- Stats Cards -->
  <app-user-stats [stats]="userStats"></app-user-stats>

  <!-- Main Content Card -->
  <div class="flex flex-col bg-surface border border-border rounded-xl shadow-sm overflow-hidden">
    <!-- Header (Title & Controls) -->
    <div
      class="p-2 md:px-6 md:py-4 border-b border-border flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between bg-surface">
      <!-- Left Side: Title & Info -->
      <div class="flex-1 min-w-0">
        <h3 class="text-lg font-semibold text-text-primary">
          Listado de Usuarios
        </h3>
        <p class="hidden sm:block text-xs text-text-secondary mt-0.5">
          Gestión de cuentas de usuario y permisos ({{ pagination.total }})
        </p>
      </div>

      <!-- Right Side: Controls -->
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
        <!-- Search -->
        <div class="w-full sm:w-60">
          <app-inputsearch placeholder="Buscar usuarios..." [debounceTime]="400" (searchChange)="onSearchChange($event)"
            size="sm" fullWidth="true"></app-inputsearch>
        </div>

        <!-- Filter Selector (State) -->
        <div class="w-full sm:w-48">
          <form [formGroup]="filterForm">
            <select formControlName="state"
              class="w-full px-3 py-1.5 border border-border rounded-md bg-surface text-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm h-[38px]"
              [disabled]="isLoading">
              <option *ngFor="let state of userStates" [value]="state.value">
                {{ state.label }}
              </option>
            </select>
          </form>
        </div>

        <!-- Actions -->
        <div class="flex gap-2 items-center sm:ml-auto">
          <app-button variant="outline" size="sm" (clicked)="refreshUsers()" [disabled]="isLoading" title="Actualizar">
            <app-icon name="refresh-cw" [size]="16" slot="icon"></app-icon>
          </app-button>

          <app-button variant="primary" size="sm" (clicked)="createUser()" iconName="plus">
            <span class="hidden sm:inline">Nuevo Usuario</span>
            <span class="sm:hidden">Nuevo</span>
          </app-button>
        </div>
      </div>
    </div>

    <!-- Table Content -->
    <div class="relative min-h-[400px] p-2 md:p-4">
      <!-- Loading Overlay -->
      <div *ngIf="isLoading" class="absolute inset-0 bg-surface/50 z-10 flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>

      <!-- Table Section -->
      <app-table [data]="users" [columns]="tableColumns" [actions]="tableActions"
        (sort)="onSortChange($event.column, $event.direction)">
        <!-- Custom cell for status -->
        <ng-template #statusCell let-item>
          <span class="px-2 py-1 text-xs font-medium rounded-full" [class]="getStateDisplay(item.state).class">
            {{ getStateDisplay(item.state).text }}
          </span>
        </ng-template>

        <!-- Custom cell for 2FA -->
        <ng-template #twoFactorCell let-item>
          <div class="flex items-center gap-2">
            <app-icon name="shield" class="w-4 h-4" [ngClass]="
                item.two_factor_enabled ? 'text-green-500' : 'text-gray-400'
              "></app-icon>
            <span class="text-text">
              {{ item.two_factor_enabled ? "Sí" : "No" }}
            </span>
          </div>
        </ng-template>

        <!-- Custom cell for email verification -->
        <ng-template #emailVerifiedCell let-item>
          <div class="flex items-center gap-2">
            <app-icon name="check" class="w-4 h-4" [ngClass]="
                item.email_verified ? 'text-green-500' : 'text-yellow-500'
              "></app-icon>
            <span class="text-text">
              {{ item.email_verified ? "Verificado" : "Pendiente" }}
            </span>
          </div>
        </ng-template>

        <!-- Custom actions -->
        <ng-template #actionsCell let-item>
          <div class="flex items-center gap-2">
            <!-- Edit Button -->
            <button (click)="editUser(item)"
              class="p-1 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
              title="Editar usuario">
              <app-icon name="edit" class="w-4 h-4"></app-icon>
            </button>

            <!-- Toggle Status Button -->
            <button (click)="toggleUserStatus(item)" class="p-1 rounded transition-colors" [ngClass]="
                item.state === 'active'
                  ? 'text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20'
                  : 'text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20'
              " [title]="
                item.state === 'active' ? 'Archivar usuario' : 'Reactivar usuario'
              ">
              <app-icon name="archive" class="w-4 h-4"></app-icon>
            </button>

            <!-- Delete Button -->
            <button (click)="confirmDelete(item)"
              class="p-1 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors"
              title="Eliminar usuario">
              <app-icon name="delete" class="w-4 h-4"></app-icon>
            </button>
          </div>
        </ng-template>

        <!-- Empty State internal slot (standard practice) -->
        <div class="p-8 flex justify-center w-full" *ngIf="!isLoading && users.length === 0">
          <app-user-empty-state [title]="getEmptyStateTitle()" [description]="getEmptyStateDescription()"
            (actionClick)="createUser()">
          </app-user-empty-state>
        </div>
      </app-table>
    </div>

    <!-- Create User Modal -->
    <app-user-create-modal [(isOpen)]="showCreateModal" (onUserCreated)="onUserCreated()"></app-user-create-modal>

    <!-- Edit User Modal -->
    <app-user-edit-modal [(isOpen)]="showEditModal" [user]="currentUser"
      (onUserUpdated)="onUserUpdated()"></app-user-edit-modal>
  </div>
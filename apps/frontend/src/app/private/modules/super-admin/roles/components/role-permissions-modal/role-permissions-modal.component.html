<app-modal title="Gestionar Permisos" (close)="onCancel()">
  <div class="p-6">
    <div *ngIf="isLoading" class="flex justify-center items-center h-64">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      <p class="ml-3 text-text-secondary">Cargando permisos...</p>
    </div>

    <div *ngIf="!isLoading" class="space-y-6">
      <!-- Información del rol -->
      <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
        <h3 class="text-lg font-medium text-text-primary mb-2">{{ role?.name }}</h3>
        <p class="text-sm text-text-secondary">{{ role?.description || 'Sin descripción' }}</p>
        <div class="mt-2">
          <span 
            *ngIf="role?.is_system_role" 
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">
            <app-icon name="shield-check" class="w-3 h-3 mr-1"></app-icon>
            Rol del Sistema
          </span>
          <span 
            *ngIf="!role?.is_system_role" 
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
            <app-icon name="users" class="w-3 h-3 mr-1"></app-icon>
            Rol Personalizado
          </span>
        </div>
      </div>

      <!-- Lista de permisos agrupados por recurso -->
      <form [formGroup]="permissionsForm">
        <div class="space-y-6">
          <div *ngFor="let group of getPermissionGroup(availablePermissions) | keyvalue" class="border border-border rounded-lg p-4">
            <h4 class="text-md font-medium text-text-primary mb-4 flex items-center">
              <app-icon name="folder" class="w-4 h-4 mr-2"></app-icon>
              {{ getResourceDisplayName(group.key) }}
            </h4>
            
            <div class="space-y-3">
              <div *ngFor="let permission of group.value" class="flex items-center justify-between p-3 bg-surface rounded-md">
                <div class="flex items-center flex-1">
                  <input 
                    type="checkbox" 
                    [id]="'permission-' + permission.id"
                    [checked]="isPermissionSelected(permission.id)"
                    (change)="togglePermission(permission.id, $event)"
                    class="h-4 w-4 text-primary focus:ring-primary border-border rounded">
                  <label [for]="'permission-' + permission.id" class="ml-3 flex-1 cursor-pointer">
                    <div class="flex items-center justify-between">
                      <div>
                        <span class="text-sm font-medium text-text-primary">{{ permission.name }}</span>
                        <p class="text-xs text-text-secondary mt-1">{{ permission.description }}</p>
                      </div>
                      <div class="flex items-center space-x-2 ml-4">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium {{ getMethodBadgeClass(permission.method) }}">
                          {{ permission.method }}
                        </span>
                        <span class="text-xs text-text-secondary font-mono">{{ permission.path }}</span>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      <!-- Resumen de permisos seleccionados -->
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-2">
          Resumen de Permisos
        </h4>
        <p class="text-sm text-blue-700 dark:text-blue-300">
          Has seleccionado {{ permissionsForm.get('selectedPermissions')?.value?.length || 0 }} de {{ availablePermissions.length }} permisos disponibles.
        </p>
      </div>
    </div>
  </div>
  
  <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800 flex justify-end gap-3">
    <button 
      type="button" 
      (click)="onCancel()" 
      class="px-4 py-2 text-text bg-surface border border-border rounded-md hover:bg-surface-hover transition-colors"
      [disabled]="isSaving">
      Cancelar
    </button>
    <button 
      type="button" 
      (click)="savePermissions()" 
      [disabled]="isSaving || isLoading"
      class="px-4 py-2 text-white bg-primary hover:bg-primary/90 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center">
      <span *ngIf="isSaving" class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>
      Guardar Permisos
    </button>
  </div>
</app-modal>
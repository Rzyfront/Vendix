<!-- Standard Module Layout -->
<div class="flex flex-col gap-6">

  <!-- Stats Grid -->
  <div class="stats-container">
    <app-stats
      title="Total Tickets"
      [value]="ticketStats.total"
      smallText="Todos los tickets"
      iconName="ticket"
      iconBgColor="bg-blue-100"
      iconColor="text-blue-600"
    ></app-stats>
    <app-stats
      title="Abiertos"
      [value]="ticketStats.open_tickets"
      smallText="Tickets en proceso"
      iconName="folder"
      iconBgColor="bg-yellow-100"
      iconColor="text-yellow-600"
    ></app-stats>
    <app-stats
      title="Resueltos"
      [value]="ticketStats.resolved"
      smallText="Tickets cerrados"
      iconName="check-circle"
      iconBgColor="bg-emerald-100"
      iconColor="text-emerald-600"
    ></app-stats>
    <app-stats
      title="Vencidos"
      [value]="ticketStats.overdue"
      smallText="SLA vencido"
      iconName="alert-triangle"
      iconBgColor="bg-red-100"
      iconColor="text-red-600"
    ></app-stats>
  </div>

  <!-- Main Content Card -->
  <div class="flex flex-col bg-surface border border-border rounded-xl shadow-sm overflow-hidden">
    <!-- Table Header (Title, Description, Controls) -->
    <div
      class="p-2 md:px-6 md:py-4 border-b border-border flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between bg-surface">
      <div class="flex-1 min-w-0">
        <h3 class="text-lg font-semibold text-text-primary">
          Tickets de Soporte
        </h3>
        <p class="hidden sm:block text-xs text-text-secondary mt-0.5">
          Gestiona todos los tickets de soporte del sistema
        </p>
      </div>

      <!-- Search & Filters -->
      <form [formGroup]="filterForm" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
        <!-- Search -->
        <div class="w-full sm:w-60">
          <app-inputsearch
            placeholder="Buscar tickets..."
            [debounceTime]="300"
            (searchChange)="onSearch($event)"
            size="sm"
            fullWidth="true"
          ></app-inputsearch>
        </div>

        <!-- Status Filter -->
        <div class="w-full sm:w-48">
          <app-selector
            placeholder="Estado"
            [options]="statusOptions"
            formControlName="status"
            size="sm"
            variant="outline"
          ></app-selector>
        </div>

        <!-- Priority Filter -->
        <div class="w-full sm:w-48">
          <app-selector
            placeholder="Prioridad"
            [options]="priorityOptions"
            formControlName="priority"
            size="sm"
            variant="outline"
          ></app-selector>
        </div>
      </form>
    </div>

    <!-- Table Container -->
    <div class="relative min-h-[400px] p-2 md:p-4">
      <!-- Loading Overlay -->
      <div *ngIf="isLoading" class="absolute inset-0 bg-surface/50 z-10 flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>

      <!-- Table -->
      <app-responsive-data-view
        *ngIf="!isLoading"
        [data]="tickets"
        [columns]="columns"
        [actions]="actions"
        [cardConfig]="cardConfig"
        [hoverable]="true"
        [striped]="true"
        [emptyMessage]="'No se encontraron tickets'"
        [emptyIcon]="'ticket'"
        tableSize="md"
        (rowClick)="viewTicket($event)"
      >
      </app-responsive-data-view>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<app-modal
  [isOpen]="showAssignModal"
  [title]="'Asignar Ticket'"
  [subtitle]="'Selecciona un usuario para asignar este ticket'"
  (cancel)="showAssignModal = false"
  (isOpenChange)="showAssignModal = $event"
>
  <form [formGroup]="assignForm" class="space-y-4">
    <div>
      <label class="block text-sm font-semibold text-text-primary mb-2">
        Buscar Usuario
      </label>
      <input
        type="text"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:border-transparent"
        placeholder="Escribe el nombre o correo del usuario..."
        (input)="onUserSearch($event)"
      />
    </div>

    <div *ngIf="loadingUsers" class="text-center py-4">
      <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"></div>
    </div>

    <div *ngIf="!loadingUsers && users.length > 0" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
      <div
        *ngFor="let user of users"
        class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
        (click)="selectUser(user.id)"
        [class.bg-primary\/10]="assignForm.get('assigned_to_user_id')?.value === user.id"
      >
        <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
          <span class="text-sm font-semibold text-primary">
            {{ user.first_name?.[0] || '?' }}{{ user.last_name?.[0] || '' }}
          </span>
        </div>
        <div class="flex-1">
          <div class="text-sm font-medium text-text-primary">
            {{ user.first_name }} {{ user.last_name }}
          </div>
          <div class="text-xs text-text-secondary">
            {{ user.email }}
          </div>
        </div>
        <div *ngIf="assignForm.get('assigned_to_user_id')?.value === user.id" class="text-primary">
          <app-icon name="check" [size]="18"></app-icon>
        </div>
      </div>
    </div>

    <div *ngIf="!loadingUsers && users.length === 0" class="text-center py-4 text-text-secondary text-sm">
      No se encontraron usuarios
    </div>

    <input type="hidden" formControlName="assigned_to_user_id" />
  </form>

  <div slot="footer" class="flex justify-end gap-3">
    <app-button
      variant="ghost"
      (clicked)="showAssignModal = false"
      size="sm"
    >
      Cancelar
    </app-button>
    <app-button
      variant="primary"
      (clicked)="assignTicket()"
      size="sm"
    >
      Asignar
    </app-button>
  </div>
</app-modal>

### VENDIX - Complete Onboarding API Tests
### Archivo completo para probar todos los endpoints de onboarding

@baseUrl = http://localhost:3000/api
@access_token = TU_TOKEN_AQUI
@organization_id = TU_ORGANIZATION_ID_AQUI
@store_id = TU_STORE_ID_AQUI

### ============================================
### 0. HEALTH CHECK - Verificar servidor
### ============================================
GET {{baseUrl}}/health

### ============================================
### 1. REGISTRO DE USUARIO OWNER PARA TESTING
### ============================================
POST {{baseUrl}}/auth/register-owner
Content-Type: application/json

{
  "organizationName": "Test Organization Onboarding",
  "email": "testonboarding@example.com",
  "password": "TestPass123!",
  "first_name": "Test",
  "last_name": "Onboarding"
}

### ============================================
### 2. LOGIN PARA OBTENER TOKEN
### ============================================
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "testonboarding@example.com",
  "password": "TestPass123!",
  "organizationSlug": "test-organization-onboarding"
}

### ============================================
### 3. VERIFICAR EMAIL (SIMULAR VERIFICACIÓN)
### ============================================
# UPDATE users SET email_verified = true WHERE email = 'testonboarding@example.com';

### ============================================
### ONBOARDING FLOW - PASO A PASO
### ============================================

### ============================================
### 3.1. CHECK ONBOARDING STATUS - GET
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer {{access_token}}

### ============================================
### 3.2. INTENTO SIN AUTENTICACIÓN - 401
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json

### ============================================
### 3.3. INTENTO CON TOKEN INVÁLIDO - 401
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer invalid_token

### ============================================
### 3.4. INTENTO CON USUARIO NO OWNER - 409
### ============================================
# NOTA: Para probar este caso, usa un token de un usuario que no sea owner

GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer non_owner_token


### ============================================
### 4. SETUP ORGANIZACIÓN - SE USA COMÚNMENTE PORQUE EL REGISTER OWNER YA PRECREA UNA ORGANIZACIÓN
### ============================================
POST {{baseUrl}}/auth/onboarding/setup-organization/{{organization_id}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "description": "Empresa dedicada al comercio electrónico y distribución",
  "phone": "+57 300 123 4567",
  "website": "https://miempresa.com",
  "address_line1": "Calle 123 #45-67",
  "address_line2": "Oficina 301",
  "city": "Bogotá",
  "state_province": "Cundinamarca",
  "postal_code": "110111",
  "country_code": "CO"
}

### ============================================
### 5. CREAR TIENDA DURANTE ONBOARDING
### ============================================
POST {{baseUrl}}/auth/onboarding/create-store/{{organization_id}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Tienda Principal",
  "description": "Tienda principal de la empresa",
  "phone": "+57 301 987 6543",
  "email": "tienda@miempresa.com",
  "address_line1": "Carrera 45 #123-45",
  "city": "Bogotá",
  "state_province": "Cundinamarca",
  "postal_code": "110111",
  "country_code": "CO",
  "currency_code": "COP",
  "timezone": "America/Bogota"
}

### ============================================
### 6. SETUP TIENDA
### ============================================
POST {{baseUrl}}/auth/onboarding/setup-store/{{store_id}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "description": "Tienda principal con productos de calidad",
  "phone": "+57 301 987 6543",
  "email": "ventas@miempresa.com",
  "address_line1": "Carrera 45 #123-45",
  "address_line2": "Local 1",
  "city": "Bogotá",
  "state_province": "Cundinamarca",
  "postal_code": "110111",
  "country_code": "CO",
  "currency_code": "COP",
  "timezone": "America/Bogota",
  "track_inventory": true,
  "allow_backorders": false,
  "low_stock_threshold": 5,
  "enable_shipping": true,
  "free_shipping_threshold": 100000,
  "enable_cod": true,
  "enable_online_payments": true
}

### ============================================
### 7. VERIFICAR ESTADO DESPUÉS DE SETUP
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer {{access_token}}

### ============================================
### 7.1. CONFIGURAR DOMINIO PARA ONBOARDING
### ============================================
POST {{baseUrl}}/domain-settings
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "hostname": "test-organization-onboarding.localhost",
  "organizationId": {{organization_id}},
  "config": {
    "branding": {
      "primaryColor": "#007bff",
      "secondaryColor": "#6c757d"
    }
  }
}

### ============================================
### 8. COMPLETAR ONBOARDING
### ============================================
POST {{baseUrl}}/auth/onboarding/complete
Content-Type: application/json
Authorization: Bearer {{access_token}}

{}

### ============================================
### 9. VERIFICAR ESTADO FINAL
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer {{access_token}}

### ============================================
### ERROR CASES TESTING
### ============================================

### ============================================
### 11. INTENTO REPETIR COMPLETADO - 400
### ============================================
POST {{baseUrl}}/auth/onboarding/complete
Content-Type: application/json
Authorization: Bearer {{access_token}}

{}

### ============================================
### 12. INTENTO CREAR ORGANIZACIÓN YA EXISTENTE - 400
### ============================================
POST {{baseUrl}}/auth/onboarding/create-organization
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Otra Empresa",
  "description": "Otra empresa de prueba"
}

### ============================================
### 13. INTENTO SETUP ORGANIZACIÓN INEXISTENTE - 400
### ============================================
POST {{baseUrl}}/auth/onboarding/setup-organization/99999
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "description": "Descripción de prueba"
}

### ============================================
### 14. INTENTO CREAR TIENDA EN ORGANIZACIÓN INEXISTENTE - 400
### ============================================
POST {{baseUrl}}/auth/onboarding/create-store/99999
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Tienda de Prueba"
}

### ============================================
### 15. INTENTO SETUP TIENDA INEXISTENTE - 400
### ============================================
POST {{baseUrl}}/auth/onboarding/setup-store/99999
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "description": "Descripción de prueba"
}

### ============================================
### VERIFICACIÓN EN BASE DE DATOS
### ============================================

### ============================================
### 16. VERIFICAR DATOS EN BD
### ============================================
# SELECT
#   u.id, u.email, u.first_name, u.last_name, u.email_verified, u.onboarding_completed,
#   o.name as org_name, o.description as org_description,
#   s.name as store_name, s.description as store_description
# FROM users u
# LEFT JOIN organizations o ON u.organization_id = o.id
# LEFT JOIN stores s ON s.organization_id = o.id
# WHERE u.email = 'testonboarding@example.com';

### ============================================
### 17. LIMPIEZA - Reset para próximos tests
### ============================================
# UPDATE users SET onboarding_completed = false WHERE email = 'testonboarding@example.com';
# DELETE FROM stores WHERE organization_id = (SELECT id FROM organizations WHERE name = 'Mi Empresa S.A.');
# DELETE FROM organizations WHERE name = 'Mi Empresa S.A.';
# DELETE FROM users WHERE email = 'testonboarding@example.com';

### ============================================
### TESTING CON USUARIO CUSTOMER (DEBE FALLAR)
### ============================================

### ============================================
### 18. REGISTRO DE USUARIO CUSTOMER
### ============================================
POST {{baseUrl}}/auth/register-customer
Content-Type: application/json

{
  "email": "testcustomer@example.com",
  "password": "TestPass123!",
  "first_name": "Test",
  "last_name": "Customer",
  "storeId": 1
}

### ============================================
### 19. LOGIN CUSTOMER
### ============================================
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "testcustomer@example.com",
  "password": "TestPass123!",
  "storeSlug": "test-store"
}

### ============================================
### 20. INTENTO ACCEDER A ONBOARDING CON CUSTOMER - 409
### ============================================
GET {{baseUrl}}/auth/onboarding/status
Content-Type: application/json
Authorization: Bearer {{access_token}}

### ============================================
### 21. LIMPIEZA CUSTOMER TEST
### ============================================
# DELETE FROM users WHERE email = 'testcustomer@example.com';
